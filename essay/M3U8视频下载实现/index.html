<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <meta name="sogou_site_verification" content="6EV6mkKQug">
  
  <title>IT Go</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="瞎搞事的博客">
  
  <meta name="description" content="前段时间由于业务需要，需要做一个视频下载的功能，包括m3u8视频和mp4视频等，于是在Github上找了几个相关的下载库，发现要不是太久没有更新了，要不就是不太符合我们的需求，所以干脆就手撸了一个M3U8Downloader  Github地址：https://github.com/xuqingquan1995/M3U8Downloader Gitee地址：https://gitee.com/">
<meta name="keywords" content="Android">
<meta property="og:type" content="article">
<meta property="og:title" content="M3U8视频下载实现">
<meta property="og:url" content="https://blog.it9.top/essay/M3U8视频下载实现/index.html">
<meta property="og:site_name" content="IT Go">
<meta property="og:description" content="前段时间由于业务需要，需要做一个视频下载的功能，包括m3u8视频和mp4视频等，于是在Github上找了几个相关的下载库，发现要不是太久没有更新了，要不就是不太符合我们的需求，所以干脆就手撸了一个M3U8Downloader  Github地址：https://github.com/xuqingquan1995/M3U8Downloader Gitee地址：https://gitee.com/">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://blog.it9.top/blog_images/m3u8Downloader_1.png">
<meta property="og:updated_time" content="2019-10-25T10:58:10.557Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="M3U8视频下载实现">
<meta name="twitter:description" content="前段时间由于业务需要，需要做一个视频下载的功能，包括m3u8视频和mp4视频等，于是在Github上找了几个相关的下载库，发现要不是太久没有更新了，要不就是不太符合我们的需求，所以干脆就手撸了一个M3U8Downloader  Github地址：https://github.com/xuqingquan1995/M3U8Downloader Gitee地址：https://gitee.com/">
<meta name="twitter:image" content="https://blog.it9.top/blog_images/m3u8Downloader_1.png">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/pace.min.js"></script>
<script>
 (function() {
    var src;
    if (document.location.protocol == "http:") {
        src = "http://js.passport.qihucdn.com/11.0.1.js?55d431fa6c5ac2f680df02398a4e06a6";
    } else {
        src = "https://jspassport.ssl.qhimg.com/11.0.1.js?55d431fa6c5ac2f680df02398a4e06a6";
    }
    document.write('<script src="' + src + '" id="sozz"><\/script>');
    console.log("360push");
})(); (function() {
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    } else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
    console.log("baidupush");
})();
</script>
  

  
	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?73ea46c1b5fcdd8bdba5763824704213";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>

  

</head>
</html>
<body>
  <div id="container">
      <header id="header">
    <div id="banner"></div>
    <div id="header-outer">
        <div id="header-menu" class="header-menu-pos animated">
            <div class="header-menu-container">
                <a href="/" class="left">
                    <span class="site-title">IT Go</span>
                </a>
                <nav id="header-menu-nav" class="right">
                    
                    <a href="/">
                        <i class="fa fa-home"></i>
                        <span>主页</span>
                    </a>
                    
                    <a href="/archives">
                        <i class="fa fa-list"></i>
                        <span>全部</span>
                    </a>
                    
                    <a href="/categories/essay">
                        <i class="fa fa-edit"></i>
                        <span>随笔</span>
                    </a>
                    
                    <a href="/categories/note">
                        <i class="fa fa-sticky-note"></i>
                        <span>小知识</span>
                    </a>
                    
                    <a href="/about">
                        <i class="fa fa-user"></i>
                        <span>关于</span>
                    </a>
                    
                </nav>
                <a class="mobile-header-menu-button">
                    <i class="fa fa-bars"></i>
                </a>
            </div>
        </div>
        <div id="header-row">
            <div id="logo">
                <a href="/">
                    <img src="/images/logo.jpeg" alt="logo">
                </a>
            </div>
            <div class="header-info">
                <div id="header-title">
                    
                    <h2>
                        瞎搞事
                    </h2>
                    
                </div>
                <div id="header-description">
                    
                    <h3>
                        瞎搞事，瞎折腾，瞎扯淡
                    </h3>
                    
                </div>
            </div>
            <nav class="header-nav">
                <div class="social">
                    
                        <a title="博客" target="_blank" href="/">
                            <i class="fa fa-home fa-2x"></i></a>
                    
                        <a title="GitHub" target="_blank" href="//github.com/xuqingquan1995">
                            <i class="fa fa-github fa-2x"></i></a>
                    
                        <a title="QQ" target="_blank" href="tencent://message/?uin=1324569122&Menu=yes&Service=300&sigT=42a1e5347953b64c5ff3980f8a6e644d4b31456cb0b6ac6b27663a3c4dd0f4aa14a543b1716f9d45">
                            <i class="fa fa-qq fa-2x"></i></a>
                    
                        <a title="Mail" target="_blank" href="mailto:xuqingquan1995@gmail.com">
                            <i class="fa fa-envelope fa-2x"></i></a>
                    
                </div>
            </nav>
        </div>
    </div>
</header>
      <div class="outer">
        <section id="main" class="body-wrap"><article id="post-M3U8视频下载实现" class="article article-type-post" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        
        <header class="article-header">
            
  
    <h1 class="post-title" itemprop="name">
      M3U8视频下载实现
    </h1>
    <div class="post-title-bar">
      <ul>
          
              <li>
                  <i class="fa fa-book"></i>
                  
                      <a href="/categories/随笔/">随笔</a>
                  
              </li>
          
        <li>
          <i class="fa fa-calendar"></i>  2019-10-25
        </li>
        <li>
          <i class="fa fa-eye"></i>
          <span id="busuanzi_value_page_pv"></span>
        </li>
      </ul>
    </div>
  

            
        </header>
        
        <div class="article-entry post-content" itemprop="articleBody">
            
                
                <p><center><iframe height="480" width="270" src="/blog_images/m3u8Downloader_2.mp4" allowfullscreen></iframe></center></p>
<blockquote>
<p>前段时间由于业务需要，需要做一个视频下载的功能，包括m3u8视频和mp4视频等，于是在Github上找了几个相关的下载库，发现要不是太久没有更新了，要不就是不太符合我们的需求，所以干脆就手撸了一个<code>M3U8Downloader</code></p>
</blockquote>
<p><code>Github</code>地址：<a href="https://github.com/xuqingquan1995/M3U8Downloader" target="_blank" rel="noopener">https://github.com/xuqingquan1995/M3U8Downloader</a></p>
<p><code>Gitee</code>地址：<a href="https://gitee.com/xuqingquan/M3U8Downloader" target="_blank" rel="noopener">https://gitee.com/xuqingquan/M3U8Downloader</a></p>
<h2 id="M3U8文件结构"><a href="#M3U8文件结构" class="headerlink" title="M3U8文件结构"></a>M3U8文件结构</h2><p>开始撸代码之前，先预备一下相关知识，M3U8视频其实主要就一个文件，文件里面写明了视频片段ts的地址，我们获得这个m3u8文件就可以通过文件内的内容，分析出世纪的ts，然后下载相对应的ts文件，就可以做到下载m3u8视频了</p>
<h3 id="最直接的m3u8文件"><a href="#最直接的m3u8文件" class="headerlink" title="最直接的m3u8文件"></a>最直接的m3u8文件</h3><blockquote>
<p><a href="https://135zyv5.xw0371.com/2018/10/29/X05c7CG3VB91gi1M/playlist.m3u8" target="_blank" rel="noopener">https://135zyv5.xw0371.com/2018/10/29/X05c7CG3VB91gi1M/playlist.m3u8</a><br>这个链接的m3u8文件下载后内容如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class="line">#EXT-X-ALLOW-CACHE:YES</span><br><span class="line">#EXT-X-TARGETDURATION:19</span><br><span class="line">#EXTINF:12.640000,</span><br><span class="line">out000.ts</span><br><span class="line">#EXTINF:7.960000,</span><br><span class="line">out001.ts</span><br><span class="line">#EXTINF:12.280000,</span><br><span class="line">out002.ts</span><br><span class="line">#EXTINF:7.520000,</span><br><span class="line">out003.ts</span><br><span class="line">#EXTINF:10.240000,</span><br><span class="line">out004.ts</span><br><span class="line">#EXTINF:15.520000,</span><br><span class="line">out005.ts</span><br><span class="line">#EXTINF:8.600000,</span><br><span class="line">out006.ts</span><br><span class="line">#EXTINF:7.440000,</span><br><span class="line">out007.ts</span><br><span class="line">#EXTINF:8.240000,</span><br><span class="line">out008.ts</span><br><span class="line">#EXTINF:10.000000,</span><br><span class="line">out009.ts</span><br><span class="line">#EXTINF:13.120000,</span><br><span class="line">out010.ts</span><br><span class="line">。。。。。。。</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>可以很直观的看出，其实这个文件里面是一系列的ts文件</p>
<h3 id="需要重定向的m3u8"><a href="#需要重定向的m3u8" class="headerlink" title="需要重定向的m3u8"></a>需要重定向的m3u8</h3><p>还有例如以下这两个链接的m3u8文件下载后内容如下,只有简单的一行</p>
<blockquote>
<p><a href="http://youku.cdn-iqiyi.com/20180523/11112_b1fb9d8b/index.m3u8" target="_blank" rel="noopener">http://youku.cdn-iqiyi.com/20180523/11112_b1fb9d8b/index.m3u8</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=800000,RESOLUTION=1080x608</span><br><span class="line">1000k/hls/index.m3u8</span><br></pre></td></tr></table></figure></p>
</blockquote>
<blockquote>
<p><a href="https://v8.yongjiu8.com/20180321/V8I5Tg8p/index.m3u8" target="_blank" rel="noopener">https://v8.yongjiu8.com/20180321/V8I5Tg8p/index.m3u8</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-STREAM-INF:PROGRAM-ID=1,BANDWIDTH=1000000,RESOLUTION=1280x720</span><br><span class="line">/ppvod/1F94756C565EC42C5735D57272032622.m3u8</span><br></pre></td></tr></table></figure></p>
</blockquote>
<p>对于这一类的m3u8文件，其实是需要重定向的，重定向后可以获得真实的m3u8地址，从而获取到对应的ts地址</p>
<p>根据url规则，以上两个m3u8的实际地址为：</p>
<p><a href="http://youku.cdn-iqiyi.com/20180523/11112_b1fb9d8b/index.m3u8" target="_blank" rel="noopener">http://youku.cdn-iqiyi.com/20180523/11112_b1fb9d8b/index.m3u8</a> 转为：<a href="http://youku.cdn-iqiyi.com/20180523/11112_b1fb9d8b/1000k/hls/index.m3u8" target="_blank" rel="noopener">http://youku.cdn-iqiyi.com/20180523/11112_b1fb9d8b/1000k/hls/index.m3u8</a></p>
<p><a href="https://v8.yongjiu8.com/20180321/V8I5Tg8p/index.m3u8" target="_blank" rel="noopener">https://v8.yongjiu8.com/20180321/V8I5Tg8p/index.m3u8</a> 转为：<a href="https://v8.yongjiu8.com/ppvod/1F94756C565EC42C5735D57272032622.m3u8" target="_blank" rel="noopener">https://v8.yongjiu8.com/ppvod/1F94756C565EC42C5735D57272032622.m3u8</a></p>
<h3 id="ts文件分析"><a href="#ts文件分析" class="headerlink" title="ts文件分析"></a>ts文件分析</h3><p>对于获取到的ts文件主要有以下几种类型：</p>
<ul>
<li><p>只有文件名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-TARGETDURATION:9</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class="line">#EXTINF:4.276000,</span><br><span class="line">65f7a658c87000.ts</span><br><span class="line">#EXTINF:4.170000,</span><br><span class="line">65f7a658c87001.ts</span><br><span class="line">#EXTINF:5.754600,</span><br><span class="line">65f7a658c87002.ts</span><br><span class="line">#EXTINF:4.170000,</span><br><span class="line">65f7a658c87003.ts</span><br><span class="line">#EXTINF:4.170000,</span><br></pre></td></tr></table></figure>
</li>
<li><p>带有路径的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#EXTM3U</span><br><span class="line">#EXT-X-VERSION:3</span><br><span class="line">#EXT-X-TARGETDURATION:10</span><br><span class="line">#EXT-X-MEDIA-SEQUENCE:0</span><br><span class="line">#EXTINF:10,</span><br><span class="line">/20180321/V8I5Tg8p/1000kb/hls/bdmhnU1119000.ts</span><br><span class="line">#EXTINF:10,</span><br><span class="line">/20180321/V8I5Tg8p/1000kb/hls/bdmhnU1119001.ts</span><br><span class="line">#EXTINF:10,</span><br><span class="line">/20180321/V8I5Tg8p/1000kb/hls/bdmhnU1119002.ts</span><br><span class="line">#EXTINF:10,</span><br><span class="line">/20180321/V8I5Tg8p/1000kb/hls/bdmhnU1119003.ts</span><br><span class="line">#EXTINF:7.8,</span><br><span class="line">/20180321/V8I5Tg8p/1000kb/hls/bdmhnU1119004.ts</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>其实也是根据url规则进行替换，对于只有文件名的ts文件，只要把它对应的m3u8地址最后的文件名替换成ts文件名就行了，对于带有路径的，根据url规则，如果以/开头的，则代表是在域名根目录下的，不是/开头的，则代表是在当前目录下的，进行相应替换就可以得到ts文件的url地址了</p>
<h2 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h2><p>既然是下载，免不了的是涉及到网络请求的实现，其实就是具体的下载怎么去做，在<code>Github</code>上有找到一个<a href="https://github.com/lingochamp/okdownload" target="_blank" rel="noopener">okdownload</a>这个库，之所以选择它，一方面是他是下载库star最多的<a href="https://github.com/lingochamp/FileDownloader" target="_blank" rel="noopener">FileDownloader</a>的升级版,另一方面是它的批下载功能符合我下载m3u8这样多个ts文件的场景</p>
<h2 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h2><h3 id="数据类型准备"><a href="#数据类型准备" class="headerlink" title="数据类型准备"></a>数据类型准备</h3><p><code>VideoDownloadEntity</code>主要是存储过程中的数据，并且方便之后操作的<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">val</span> NO_START = <span class="number">0</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">val</span> PREPARE = <span class="number">1</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">val</span> DOWNLOADING = <span class="number">2</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">val</span> PAUSE = <span class="number">3</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">val</span> COMPLETE = <span class="number">4</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">val</span> ERROR = <span class="number">5</span></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">val</span> DELETE = -<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VideoDownloadEntity</span></span>(</span><br><span class="line">    <span class="keyword">var</span> originalUrl: String,<span class="comment">//原始下载链接</span></span><br><span class="line">    <span class="keyword">var</span> name: String = <span class="string">""</span>,<span class="comment">//视频名称</span></span><br><span class="line">    <span class="keyword">var</span> subName: String = <span class="string">""</span>,<span class="comment">//视频子名称</span></span><br><span class="line">    <span class="keyword">var</span> redirectUrl: String = <span class="string">""</span>,<span class="comment">//重定向后的下载链接</span></span><br><span class="line">    <span class="keyword">var</span> fileSize: <span class="built_in">Long</span> = <span class="number">0</span>,<span class="comment">//文件总大小</span></span><br><span class="line">    <span class="keyword">var</span> currentSize: <span class="built_in">Long</span> = <span class="number">0</span>,<span class="comment">//当前已下载大小</span></span><br><span class="line">    <span class="keyword">var</span> currentProgress: <span class="built_in">Double</span> = <span class="number">0.0</span>,<span class="comment">//当前进度</span></span><br><span class="line">    <span class="keyword">var</span> currentSpeed: String = <span class="string">""</span>,<span class="comment">//当前速率</span></span><br><span class="line">    <span class="keyword">var</span> tsSize: <span class="built_in">Int</span> = <span class="number">0</span>,<span class="comment">//ts的数量</span></span><br><span class="line">    <span class="keyword">var</span> createTime: <span class="built_in">Long</span> = System.currentTimeMillis()<span class="comment">//创建时间</span></span><br><span class="line">) : Parcelable, Comparable&lt;VideoDownloadEntity&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//状态</span></span><br><span class="line">    <span class="keyword">var</span> status: <span class="built_in">Int</span> = NO_START</span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            <span class="keyword">if</span> (field != DELETE) &#123;</span><br><span class="line">                field = value</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (value == DELETE) &#123;</span><br><span class="line">                startDownload = <span class="literal">null</span></span><br><span class="line">                downloadContext?.stop()</span><br><span class="line">                downloadTask?.cancel()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> downloadContext: DownloadContext? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">var</span> downloadTask: DownloadTask? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">var</span> startDownload: (() -&gt; <span class="built_in">Unit</span>)? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(parcel: Parcel) : <span class="keyword">this</span>(</span><br><span class="line">        parcel.readString() ?: <span class="string">""</span>,</span><br><span class="line">        parcel.readString() ?: <span class="string">""</span>,</span><br><span class="line">        parcel.readString() ?: <span class="string">""</span>,</span><br><span class="line">        parcel.readString() ?: <span class="string">""</span>,</span><br><span class="line">        parcel.readLong(),</span><br><span class="line">        parcel.readLong(),</span><br><span class="line">        parcel.readDouble(),</span><br><span class="line">        parcel.readString() ?: <span class="string">""</span>,</span><br><span class="line">        parcel.readInt(),</span><br><span class="line">        parcel.readLong()</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">this</span>.status = parcel.readInt()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">writeToParcel</span><span class="params">(parcel: <span class="type">Parcel</span>, flags: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        parcel.writeString(originalUrl)</span><br><span class="line">        parcel.writeString(name)</span><br><span class="line">        parcel.writeString(subName)</span><br><span class="line">        parcel.writeString(redirectUrl)</span><br><span class="line">        parcel.writeLong(fileSize)</span><br><span class="line">        parcel.writeLong(currentSize)</span><br><span class="line">        parcel.writeDouble(currentProgress)</span><br><span class="line">        parcel.writeString(currentSpeed)</span><br><span class="line">        parcel.writeInt(tsSize)</span><br><span class="line">        parcel.writeLong(createTime)</span><br><span class="line">        parcel.writeInt(status)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">describeContents</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> CREATOR : Parcelable.Creator&lt;VideoDownloadEntity&gt; &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">createFromParcel</span><span class="params">(parcel: <span class="type">Parcel</span>)</span></span>: VideoDownloadEntity &#123;</span><br><span class="line">            <span class="keyword">return</span> VideoDownloadEntity(parcel)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">newArray</span><span class="params">(size: <span class="type">Int</span>)</span></span>: Array&lt;VideoDownloadEntity?&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> arrayOfNulls(size)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">toString</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">val</span> json = JSONObject()</span><br><span class="line">        json.put(<span class="string">"originalUrl"</span>, originalUrl)</span><br><span class="line">        json.put(<span class="string">"name"</span>, name)</span><br><span class="line">        json.put(<span class="string">"subName"</span>, subName)</span><br><span class="line">        json.put(<span class="string">"redirectUrl"</span>, redirectUrl)</span><br><span class="line">        json.put(<span class="string">"fileSize"</span>, fileSize)</span><br><span class="line">        json.put(<span class="string">"currentSize"</span>, currentSize)</span><br><span class="line">        json.put(<span class="string">"currentProgress"</span>, currentProgress)</span><br><span class="line">        json.put(<span class="string">"currentSpeed"</span>, currentSpeed)</span><br><span class="line">        json.put(<span class="string">"tsSize"</span>, tsSize)</span><br><span class="line">        json.put(<span class="string">"createTime"</span>, createTime)</span><br><span class="line">        json.put(<span class="string">"status"</span>, status)</span><br><span class="line">        <span class="keyword">return</span> json.toString()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">toFile</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> path = FileDownloader.getDownloadPath(originalUrl)</span><br><span class="line">        <span class="keyword">val</span> config = File(path, <span class="string">"video.config"</span>)</span><br><span class="line">        <span class="keyword">if</span> (!config.exists() &amp;&amp; <span class="keyword">this</span>.createTime == <span class="number">0L</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.createTime = System.currentTimeMillis()</span><br><span class="line">        &#125;</span><br><span class="line">        config.writeText(toString())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">compareTo</span><span class="params">(other: <span class="type">VideoDownloadEntity</span>)</span></span> =</span><br><span class="line">        (other.createTime - <span class="keyword">this</span>.createTime).toInt()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">parseJsonToVideoDownloadEntity</span><span class="params">(jsonString: <span class="type">String</span>)</span></span>: VideoDownloadEntity? &#123;</span><br><span class="line">    <span class="keyword">if</span> (jsonString.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> json = JSONObject(jsonString)</span><br><span class="line">        <span class="keyword">val</span> entity = VideoDownloadEntity(</span><br><span class="line">            json.getString(<span class="string">"originalUrl"</span>),</span><br><span class="line">            json.getString(<span class="string">"name"</span>),</span><br><span class="line">            json.getString(<span class="string">"subName"</span>),</span><br><span class="line">            json.getString(<span class="string">"redirectUrl"</span>),</span><br><span class="line">            json.getLong(<span class="string">"fileSize"</span>),</span><br><span class="line">            json.getLong(<span class="string">"currentSize"</span>),</span><br><span class="line">            json.getDouble(<span class="string">"currentProgress"</span>),</span><br><span class="line">            json.getString(<span class="string">"currentSpeed"</span>),</span><br><span class="line">            json.getInt(<span class="string">"tsSize"</span>),</span><br><span class="line">            json.getLong(<span class="string">"createTime"</span>)</span><br><span class="line">        )</span><br><span class="line">        entity.status = json.getInt(<span class="string">"status"</span>)</span><br><span class="line">        entity</span><br><span class="line">    &#125; <span class="keyword">catch</span> (t: Throwable) &#123;</span><br><span class="line">        t.printStackTrace()</span><br><span class="line">        <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="获取真实ts路径"><a href="#获取真实ts路径" class="headerlink" title="获取真实ts路径"></a>获取真实ts路径</h3><p>下载m3u8文件，最开始是获取到真实的ts文件，那么先创建一个<code>M3U8ConfigDownloader</code>进行配置文件的获取<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">object</span> M3U8ConfigDownloader &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> downloadList = arrayListOf&lt;String&gt;()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> TAG = <span class="string">"M3U8ConfigDownloader"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//清楚所有任务，</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">        downloadList.clear()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 如果返回空则不需要下载，如果返回的文件存在了，则开始下载，否则等待下载完成</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">start</span><span class="params">(entity: <span class="type">VideoDownloadEntity</span>)</span></span>: File? &#123;</span><br><span class="line">        <span class="keyword">if</span> (entity.status == DELETE) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (downloadList.contains(entity.originalUrl)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (entity.createTime == <span class="number">0L</span>) &#123;</span><br><span class="line">            entity.createTime = System.currentTimeMillis()</span><br><span class="line">        &#125;</span><br><span class="line">        entity.redirectUrl = <span class="string">""</span></span><br><span class="line">        <span class="keyword">val</span> path = FileDownloader.getDownloadPath(entity.originalUrl)</span><br><span class="line">        <span class="keyword">val</span> config = FileDownloader.getConfigFile(entity.originalUrl)</span><br><span class="line">        <span class="keyword">val</span> realEntity = <span class="keyword">if</span> (!config.exists()) &#123;</span><br><span class="line">            entity.toFile()</span><br><span class="line">            entity</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            parseJsonToVideoDownloadEntity(config.readText()) ?: entity</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (entity.status == DELETE) &#123;</span><br><span class="line">            path.deleteRecursively()</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> m3u8ListFile = File(path, <span class="string">"m3u8.list"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">if</span> (realEntity.status != COMPLETE) &#123;<span class="comment">//没有完成的才有必要下载</span></span><br><span class="line">            Log.d(TAG, <span class="string">"init"</span>)</span><br><span class="line">            <span class="keyword">if</span> (m3u8ListFile.exists()) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"从文件下载"</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"从0开始下载"</span>)</span><br><span class="line">                realEntity.status = PREPARE</span><br><span class="line">                FileDownloader.downloadCallback.postValue(realEntity)</span><br><span class="line">                entity.toFile()</span><br><span class="line">                <span class="comment">//进入下载m3u8</span></span><br><span class="line">                downloadM3U8File(path, realEntity)</span><br><span class="line">            &#125;</span><br><span class="line">            m3u8ListFile</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下载单个文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">downloadM3U8File</span><span class="params">(path: <span class="type">File</span>, entity: <span class="type">VideoDownloadEntity</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (entity.status == DELETE) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> fileName: String</span><br><span class="line">        <span class="keyword">val</span> url = <span class="keyword">if</span> (entity.redirectUrl.isNotEmpty()) &#123;<span class="comment">//如果有了重定向的url</span></span><br><span class="line">            fileName = <span class="string">"real.m3u8"</span></span><br><span class="line">            entity.redirectUrl</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">//否则就用初始的url</span></span><br><span class="line">            fileName = <span class="string">"original.m3u8"</span></span><br><span class="line">            entity.originalUrl</span><br><span class="line">        &#125;</span><br><span class="line">        Log.d(TAG, <span class="string">"downloadM3U8File-url=<span class="variable">$url</span>,fileName=<span class="variable">$fileName</span>"</span>)</span><br><span class="line">        <span class="keyword">val</span> downloadFile = File(path, fileName)</span><br><span class="line">        DownloadTask.Builder(url, downloadFile.parentFile)</span><br><span class="line">            .setFilename(downloadFile.name)</span><br><span class="line">            .build()</span><br><span class="line">            .enqueue(<span class="keyword">object</span> : DownloadListener1() &#123;</span><br><span class="line">                <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">taskStart</span><span class="params">(task: <span class="type">DownloadTask</span>, model: <span class="type">Listener1Assist</span>.<span class="type">Listener1Model</span>)</span></span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (entity.downloadTask == <span class="literal">null</span>) &#123;</span><br><span class="line">                        entity.downloadTask = task</span><br><span class="line">                    &#125;</span><br><span class="line">                    Log.d(TAG, <span class="string">"taskStart--&gt;"</span>)</span><br><span class="line">                    downloadList.add(task.url)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">taskEnd</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                    task: <span class="type">DownloadTask</span>, cause: <span class="type">EndCause</span>, realCause: <span class="type">Exception</span>?,</span></span></span><br><span class="line"><span class="function"><span class="params">                    model: <span class="type">Listener1Assist</span>.<span class="type">Listener1Model</span></span></span></span><br><span class="line"><span class="function"><span class="params">                )</span></span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (entity.downloadTask == <span class="literal">null</span>) &#123;</span><br><span class="line">                        entity.downloadTask = task</span><br><span class="line">                    &#125;</span><br><span class="line">                    Log.d(TAG, <span class="string">"taskEnd--&gt;<span class="subst">$&#123;cause.name&#125;</span>,<span class="subst">$&#123;realCause?.message&#125;</span>"</span>)</span><br><span class="line">                    <span class="keyword">if</span> (cause == EndCause.COMPLETED) &#123;</span><br><span class="line">                        getFileContent(path, entity)</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        entity.status = ERROR</span><br><span class="line">                        downloadList.remove(entity.originalUrl)</span><br><span class="line">                        entity.startDownload = &#123;</span><br><span class="line">                            start(entity)</span><br><span class="line">                        &#125;</span><br><span class="line">                        entity.toFile()</span><br><span class="line">                        FileDownloader.downloadCallback.postValue(entity)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">progress</span><span class="params">(task: <span class="type">DownloadTask</span>, currentOffset: <span class="type">Long</span>, totalLength: <span class="type">Long</span>)</span></span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (entity.downloadTask == <span class="literal">null</span>) &#123;</span><br><span class="line">                        entity.downloadTask = task</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">connected</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                    task: <span class="type">DownloadTask</span>, blockCount: <span class="type">Int</span>, currentOffset: <span class="type">Long</span>, totalLength: <span class="type">Long</span></span></span></span><br><span class="line"><span class="function"><span class="params">                )</span></span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (entity.downloadTask == <span class="literal">null</span>) &#123;</span><br><span class="line">                        entity.downloadTask = task</span><br><span class="line">                    &#125;</span><br><span class="line">                    Log.d(TAG, <span class="string">"connected--&gt;"</span>)</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">retry</span><span class="params">(task: <span class="type">DownloadTask</span>, cause: <span class="type">ResumeFailedCause</span>)</span></span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (entity.downloadTask == <span class="literal">null</span>) &#123;</span><br><span class="line">                        entity.downloadTask = task</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 分析文件内容</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getFileContent</span><span class="params">(path: <span class="type">File</span>, entity: <span class="type">VideoDownloadEntity</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (entity.status == DELETE) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        Log.d(TAG, <span class="string">"getFileContent---<span class="variable">$entity</span>"</span>)</span><br><span class="line">        <span class="keyword">val</span> url = <span class="keyword">if</span> (entity.redirectUrl.isNotEmpty()) &#123;<span class="comment">//如果有了重定向的url</span></span><br><span class="line">            entity.redirectUrl</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">//否则就用初始的url</span></span><br><span class="line">            entity.originalUrl</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> uri = Uri.parse(url)</span><br><span class="line">        <span class="keyword">val</span> realM3U8File = File(path, <span class="string">"real.m3u8"</span>)</span><br><span class="line">        <span class="keyword">var</span> file = realM3U8File</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;<span class="comment">//直接判断真实的m3u8文件是否存在，存在则读取</span></span><br><span class="line">            file = File(path, <span class="string">"original.m3u8"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        Log.d(TAG, <span class="string">"getFileContent---<span class="subst">$&#123;file.name&#125;</span>"</span>)</span><br><span class="line">        <span class="keyword">val</span> list = file.readLines().filter &#123; !it.startsWith(<span class="string">"#"</span>) &#125;<span class="comment">//读取m3u8文件</span></span><br><span class="line">        <span class="keyword">if</span> (list.size &gt; <span class="number">1</span>) &#123;<span class="comment">//直接的m3u8的ts链接</span></span><br><span class="line">            entity.tsSize = list.size</span><br><span class="line">            entity.toFile()</span><br><span class="line">            <span class="keyword">if</span> (file != realM3U8File) &#123;</span><br><span class="line">                file.copyTo(realM3U8File)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">val</span> m3u8ListFile = File(path, <span class="string">"m3u8.list"</span>)</span><br><span class="line">            list.forEach &#123;</span><br><span class="line">                <span class="keyword">val</span> ts = <span class="keyword">if</span> (!it.startsWith(<span class="string">"/"</span>)) &#123;</span><br><span class="line">                    url.substring(<span class="number">0</span>, url.lastIndexOf(<span class="string">"/"</span>) + <span class="number">1</span>) + it</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="string">"<span class="subst">$&#123;uri.scheme&#125;</span>://<span class="subst">$&#123;uri.host&#125;</span><span class="variable">$it</span>"</span></span><br><span class="line">                &#125;</span><br><span class="line">                m3u8ListFile.appendText(<span class="string">"<span class="variable">$ts</span>\n"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">val</span> localPlaylist = File(path, <span class="string">"localPlaylist.m3u8"</span>)</span><br><span class="line">            file.readLines().forEach &#123;</span><br><span class="line">                <span class="keyword">var</span> str = it</span><br><span class="line">                <span class="keyword">if</span> (!str.startsWith(<span class="string">"#"</span>)) &#123;</span><br><span class="line">                    str = <span class="keyword">if</span> (str.contains(<span class="string">"/"</span>)) &#123;</span><br><span class="line">                        <span class="string">".ts<span class="subst">$&#123;it.substring(it.lastIndexOf("/"))&#125;</span>"</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="string">".ts/<span class="variable">$it</span>"</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                localPlaylist.appendText(<span class="string">"<span class="variable">$str</span>\n"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            Log.d(TAG, <span class="string">"start---&gt;<span class="variable">$entity</span>"</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">//重定向</span></span><br><span class="line">            <span class="keyword">val</span> newUrl = list[<span class="number">0</span>]</span><br><span class="line">            entity.redirectUrl = <span class="keyword">if</span> (newUrl.startsWith(<span class="string">"/"</span>)) &#123;</span><br><span class="line">                <span class="string">"<span class="subst">$&#123;uri.scheme&#125;</span>://<span class="subst">$&#123;uri.host&#125;</span><span class="variable">$newUrl</span>"</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                url.substring(<span class="number">0</span>, url.lastIndexOf(<span class="string">"/"</span>) + <span class="number">1</span>) + newUrl</span><br><span class="line">            &#125;</span><br><span class="line">            entity.toFile()</span><br><span class="line">            downloadM3U8File(path, entity)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在以上代码中，从一个最初始的url开始，下载对应的m3u8文件，分析如果这个m3u8是最终的ts流，将ts流的完整url写入<code>m3u8.list</code>这个文件，之后下载的都从这个文件进行下,如果这个m3u8需要重定向，那么就重组链接，再一次下载，以此循环得到最终的ts流，同时，在获取到最终ts流到时候，会构造一个本地可以播放到m3u8文件<code>localPlaylist.m3u8</code>，当视频下载完成之后就可以通过这个文件打开本地的播放器进行播放</p>
<h3 id="下载ts文件"><a href="#下载ts文件" class="headerlink" title="下载ts文件"></a>下载ts文件</h3><p>之前已经获取到真实的ts路径了，并且将这些路径保存在<code>m3u8.list</code>文件里面了，所以之后就是通过这个文件里面的路径，使用<code>okdownload</code>进行批量下载了，具体实现如下<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">object</span> M3U8Downloader &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> downloadList = arrayListOf&lt;String&gt;()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> TAG = <span class="string">"---M3U8Downloader---"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//清楚所有任务</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">        downloadList.clear()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//批下载</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">bunchDownload</span><span class="params">(path: <span class="type">File</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> config = FileDownloader.getConfigFile(path)</span><br><span class="line">        Log.d(TAG, <span class="string">"config==&gt;<span class="subst">$&#123;config.readText()&#125;</span>"</span>)</span><br><span class="line">        <span class="keyword">val</span> entity = parseJsonToVideoDownloadEntity(config.readText())</span><br><span class="line">        <span class="keyword">if</span> (entity == <span class="literal">null</span>) &#123;<span class="comment">//获取到的实体类为空的忽略</span></span><br><span class="line">            Log.d(TAG, <span class="string">"entity==null<span class="subst">$&#123;config.readText()&#125;</span>"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//如果状态是删除的就忽略</span></span><br><span class="line">        <span class="keyword">if</span> (entity.status == DELETE) &#123;</span><br><span class="line">            path.deleteRecursively()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//避免重复进入下载</span></span><br><span class="line">        <span class="keyword">if</span> (downloadList.contains(entity.originalUrl)) &#123;</span><br><span class="line">            Log.d(TAG, <span class="string">"contains"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> lastCallback = <span class="number">0L</span></span><br><span class="line">        <span class="keyword">val</span> CURRENT_PROGRESS = entity.originalUrl.hashCode()</span><br><span class="line">        <span class="keyword">val</span> speedCalculator = SpeedCalculator()</span><br><span class="line">        <span class="keyword">val</span> listener = <span class="keyword">object</span> : DownloadListener1() &#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">taskStart</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                task: <span class="type">DownloadTask</span>, model: <span class="type">Listener1Assist</span>.<span class="type">Listener1Model</span></span></span></span><br><span class="line"><span class="function"><span class="params">            )</span></span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (entity.downloadTask == <span class="literal">null</span>) &#123;</span><br><span class="line">                    entity.downloadTask = task</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">taskEnd</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                task: <span class="type">DownloadTask</span>, cause: <span class="type">EndCause</span>, realCause: <span class="type">Exception</span>?,</span></span></span><br><span class="line"><span class="function"><span class="params">                model: <span class="type">Listener1Assist</span>.<span class="type">Listener1Model</span></span></span></span><br><span class="line"><span class="function"><span class="params">            )</span></span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (entity.downloadTask == <span class="literal">null</span>) &#123;</span><br><span class="line">                    entity.downloadTask = task</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">progress</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                task: <span class="type">DownloadTask</span>, currentOffset: <span class="type">Long</span>, totalLength: <span class="type">Long</span></span></span></span><br><span class="line"><span class="function"><span class="params">            )</span></span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (entity.downloadTask == <span class="literal">null</span>) &#123;</span><br><span class="line">                    entity.downloadTask = task</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">val</span> preOffset = (task.getTag(CURRENT_PROGRESS) <span class="keyword">as</span> <span class="built_in">Long</span>?) ?: <span class="number">0</span></span><br><span class="line">                speedCalculator.downloading(currentOffset - preOffset)</span><br><span class="line">                <span class="keyword">val</span> now = System.currentTimeMillis()</span><br><span class="line">                <span class="keyword">if</span> (now - lastCallback &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">                    entity.currentSpeed = speedCalculator.speed() ?: <span class="string">""</span></span><br><span class="line">                    entity.status = DOWNLOADING</span><br><span class="line">                    entity.toFile()</span><br><span class="line">                    FileDownloader.downloadCallback.postValue(entity)</span><br><span class="line">                    lastCallback = now</span><br><span class="line">                &#125;</span><br><span class="line">                task.addTag(CURRENT_PROGRESS, currentOffset)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">connected</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                task: <span class="type">DownloadTask</span>, blockCount: <span class="type">Int</span>, currentOffset: <span class="type">Long</span>, totalLength: <span class="type">Long</span></span></span></span><br><span class="line"><span class="function"><span class="params">            )</span></span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (entity.downloadTask == <span class="literal">null</span>) &#123;</span><br><span class="line">                    entity.downloadTask = task</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">retry</span><span class="params">(task: <span class="type">DownloadTask</span>, cause: <span class="type">ResumeFailedCause</span>)</span></span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (entity.downloadTask == <span class="literal">null</span>) &#123;</span><br><span class="line">                    entity.downloadTask = task</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Log.d(TAG, <span class="string">"bunchDownload"</span>)</span><br><span class="line">        <span class="keyword">val</span> m3u8ListFile = File(path, <span class="string">"m3u8.list"</span>)</span><br><span class="line">        <span class="keyword">var</span> urls = m3u8ListFile.readLines()</span><br><span class="line">        <span class="keyword">var</span> times = <span class="number">5</span></span><br><span class="line">        <span class="keyword">while</span> (times &gt; <span class="number">0</span> &amp;&amp; urls.size != entity.tsSize) &#123;<span class="comment">//如果还有重试机会且ts数量还不完全对的话,等待100ms</span></span><br><span class="line">            urls = m3u8ListFile.readLines()</span><br><span class="line">            times--</span><br><span class="line">            Thread.sleep(<span class="number">100</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> tsDirectory = File(path, <span class="string">".ts"</span>)</span><br><span class="line">        <span class="keyword">if</span> (!tsDirectory.exists()) &#123;</span><br><span class="line">            tsDirectory.mkdir()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> builder = DownloadContext.QueueSet()</span><br><span class="line">            .setParentPathFile(tsDirectory)</span><br><span class="line">            .setMinIntervalMillisCallbackProcess(<span class="number">1000</span>)</span><br><span class="line">            .setPassIfAlreadyCompleted(<span class="literal">true</span>)</span><br><span class="line">            .commit()</span><br><span class="line">        Log.d(TAG, <span class="string">"ts.size===&gt;<span class="subst">$&#123;urls.size&#125;</span>"</span>)</span><br><span class="line">        urls.forEachIndexed &#123; index, url -&gt;</span><br><span class="line">            builder.bind(url).addTag(<span class="number">1</span>, index)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> downloadContext = builder.setListener(<span class="keyword">object</span> : DownloadContextListener &#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">taskEnd</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                context: <span class="type">DownloadContext</span>, task: <span class="type">DownloadTask</span>, cause: <span class="type">EndCause</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                realCause: <span class="type">Exception</span>?, remainCount: <span class="type">Int</span></span></span></span><br><span class="line"><span class="function"><span class="params">            )</span></span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (entity.downloadTask == <span class="literal">null</span>) &#123;</span><br><span class="line">                    entity.downloadTask = task</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (entity.downloadContext == <span class="literal">null</span>) &#123;</span><br><span class="line">                    entity.downloadContext = context</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (context.isStarted &amp;&amp; cause == EndCause.COMPLETED) &#123;</span><br><span class="line">                    <span class="keyword">val</span> progress = <span class="number">1</span> - (remainCount * <span class="number">1.0</span>) / urls.size</span><br><span class="line">                    entity.status = DOWNLOADING</span><br><span class="line">                    entity.currentProgress = progress</span><br><span class="line">                    entity.fileSize += task.file?.length() ?: <span class="number">0</span></span><br><span class="line">                    entity.currentSize += task.file?.length() ?: <span class="number">0</span></span><br><span class="line">                    <span class="keyword">val</span> now = System.currentTimeMillis()</span><br><span class="line">                    <span class="keyword">if</span> (now - lastCallback &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">                        FileDownloader.downloadCallback.postValue(entity)</span><br><span class="line">                        lastCallback = now</span><br><span class="line">                    &#125;</span><br><span class="line">                    entity.toFile()</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">queueEnd</span><span class="params">(context: <span class="type">DownloadContext</span>)</span></span> &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"queueEnd"</span>)</span><br><span class="line">                <span class="keyword">if</span> (entity.downloadContext == <span class="literal">null</span>) &#123;</span><br><span class="line">                    entity.downloadContext = context</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">when</span> (entity.currentProgress) &#123;</span><br><span class="line">                    <span class="number">1.0</span> -&gt; entity.status = COMPLETE</span><br><span class="line">                    <span class="number">0.0</span> -&gt; entity.status = ERROR</span><br><span class="line">                    <span class="keyword">else</span> -&gt; entity.status = PAUSE</span><br><span class="line">                &#125;</span><br><span class="line">                entity.toFile()</span><br><span class="line">                FileDownloader.downloadCallback.postValue(entity)</span><br><span class="line">                FileDownloader.subUseProgress(entity.originalUrl)<span class="comment">//已使用的线程数减少</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).build()</span><br><span class="line">        entity.downloadContext = downloadContext</span><br><span class="line">        entity.startDownload = &#123; downloadContext.startOnSerial(listener) &#125;</span><br><span class="line">        downloadContext.startOnSerial(listener)</span><br><span class="line">        FileDownloader.addUseProgress(entity.originalUrl)<span class="comment">//已使用的线程数增加</span></span><br><span class="line">        downloadList.add(entity.originalUrl)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过以上代码就可以进行批量下载的实现了</p>
<h2 id="MP4下载"><a href="#MP4下载" class="headerlink" title="MP4下载"></a>MP4下载</h2><p>既然对于复杂的m3u8都能下载,那么单个文件的mp4之类的肯定要支持下载的，以下为mp4的下载方案<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">object</span> SingleVideoDownloader &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> downloadList = arrayListOf&lt;String&gt;()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> TAG = <span class="string">"SingleVideoDownloader"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//清理所有任务</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">        downloadList.clear()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//下载任务的初始化</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">initConfig</span><span class="params">(entity: <span class="type">VideoDownloadEntity</span>)</span></span>: File &#123;</span><br><span class="line">        <span class="keyword">val</span> config = FileDownloader.getConfigFile(entity.originalUrl)</span><br><span class="line">        <span class="keyword">if</span> (!config.exists()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (entity.createTime == <span class="number">0L</span>) &#123;</span><br><span class="line">                entity.createTime = System.currentTimeMillis()</span><br><span class="line">            &#125;</span><br><span class="line">            entity.status = PREPARE</span><br><span class="line">            entity.fileSize = <span class="number">0</span></span><br><span class="line">            entity.currentSize = <span class="number">0</span></span><br><span class="line">            entity.toFile()</span><br><span class="line">            Log.d(TAG, <span class="string">"config==&gt;<span class="subst">$&#123;config.readText()&#125;</span>"</span>)</span><br><span class="line">            FileDownloader.downloadCallback.postValue(entity)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> config</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//下载任务的入口</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">fileDownloader</span><span class="params">(entity: <span class="type">VideoDownloadEntity</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> path = FileDownloader.getDownloadPath(entity.originalUrl)</span><br><span class="line">        <span class="keyword">if</span> (entity.status == DELETE) &#123;<span class="comment">//如果是删除状态的则忽略</span></span><br><span class="line">            path.deleteRecursively()</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (downloadList.contains(entity.originalUrl)) &#123;<span class="comment">//避免重复下载</span></span><br><span class="line">            Log.d(TAG, <span class="string">"contains---<span class="subst">$&#123;entity.originalUrl&#125;</span>,<span class="subst">$&#123;entity.name&#125;</span>"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        entity.status = PREPARE</span><br><span class="line">        entity.fileSize = <span class="number">0</span></span><br><span class="line">        entity.currentSize = <span class="number">0</span></span><br><span class="line">        FileDownloader.downloadCallback.postValue(entity)</span><br><span class="line">        <span class="keyword">var</span> lastCallback = <span class="number">0L</span></span><br><span class="line">        <span class="keyword">val</span> CURRENT_PROGRESS = entity.originalUrl.hashCode()</span><br><span class="line">        <span class="keyword">val</span> speedCalculator = SpeedCalculator()</span><br><span class="line"></span><br><span class="line">        Log.d(TAG, <span class="string">"fileDownloader"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> fileName = <span class="keyword">if</span> (entity.name.isNotEmpty()) &#123;<span class="comment">//主标题有</span></span><br><span class="line">            <span class="keyword">if</span> (entity.subName.isNotEmpty()) &#123;<span class="comment">//副标题也有</span></span><br><span class="line">                <span class="string">"<span class="subst">$&#123;entity.name&#125;</span>-<span class="subst">$&#123;entity.subName&#125;</span>.mp4"</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;<span class="comment">//只有主标题</span></span><br><span class="line">                <span class="string">"<span class="subst">$&#123;entity.name&#125;</span>.mp4"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">//没有主标题</span></span><br><span class="line">            <span class="keyword">if</span> (entity.subName.isNotEmpty()) &#123;<span class="comment">//只有副标题</span></span><br><span class="line">                <span class="string">"<span class="subst">$&#123;entity.subName&#125;</span>.mp4"</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;<span class="comment">//标题都没有</span></span><br><span class="line">                <span class="string">"index.mp4"</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> downloadFile = File(path, fileName)</span><br><span class="line">        Log.d(TAG, <span class="string">"downloadFile===&gt;<span class="subst">$&#123;downloadFile.absolutePath&#125;</span>"</span>)</span><br><span class="line">        <span class="keyword">val</span> task = DownloadTask.Builder(entity.originalUrl, downloadFile.parentFile)</span><br><span class="line">            .setFilename(downloadFile.name)</span><br><span class="line">            .setPassIfAlreadyCompleted(<span class="literal">true</span>)</span><br><span class="line">            .setMinIntervalMillisCallbackProcess(<span class="number">1000</span>)</span><br><span class="line">            .setConnectionCount(<span class="number">3</span>)</span><br><span class="line">            .build()</span><br><span class="line">        task.enqueue(<span class="keyword">object</span> : DownloadListener1() &#123;</span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">taskStart</span><span class="params">(task: <span class="type">DownloadTask</span>, model: <span class="type">Listener1Assist</span>.<span class="type">Listener1Model</span>)</span></span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (entity.downloadTask == <span class="literal">null</span>) &#123;</span><br><span class="line">                    entity.downloadTask = task</span><br><span class="line">                &#125;</span><br><span class="line">                Log.d(TAG, <span class="string">"taskStart--&gt;"</span>)</span><br><span class="line">                entity.status = PREPARE</span><br><span class="line">                entity.fileSize = <span class="number">0</span></span><br><span class="line">                entity.currentSize = <span class="number">0</span></span><br><span class="line">                entity.toFile()</span><br><span class="line">                FileDownloader.downloadCallback.postValue(entity)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">taskEnd</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                task: <span class="type">DownloadTask</span>, cause: <span class="type">EndCause</span>, realCause: <span class="type">Exception</span>?,</span></span></span><br><span class="line"><span class="function"><span class="params">                model: <span class="type">Listener1Assist</span>.<span class="type">Listener1Model</span></span></span></span><br><span class="line"><span class="function"><span class="params">            )</span></span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (entity.downloadTask == <span class="literal">null</span>) &#123;</span><br><span class="line">                    entity.downloadTask = task</span><br><span class="line">                &#125;</span><br><span class="line">                Log.d(TAG, <span class="string">"taskEnd--&gt;<span class="subst">$&#123;cause.name&#125;</span>,<span class="subst">$&#123;realCause?.message&#125;</span>"</span>)</span><br><span class="line">                <span class="keyword">when</span> (cause) &#123;</span><br><span class="line">                    EndCause.COMPLETED -&gt; entity.status = COMPLETE</span><br><span class="line">                    EndCause.CANCELED -&gt; &#123;</span><br><span class="line">                        entity.status = PAUSE</span><br><span class="line">                        entity.startDownload = &#123;</span><br><span class="line">                            fileDownloader(entity)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">                        entity.status = ERROR</span><br><span class="line">                        entity.startDownload = &#123;</span><br><span class="line">                            fileDownloader(entity)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                entity.toFile()</span><br><span class="line">                FileDownloader.downloadCallback.postValue(entity)</span><br><span class="line">                downloadList.remove(entity.originalUrl)</span><br><span class="line">                FileDownloader.subUseProgress(task.url)<span class="comment">//已使用的线程数减少</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">progress</span><span class="params">(task: <span class="type">DownloadTask</span>, currentOffset: <span class="type">Long</span>, totalLength: <span class="type">Long</span>)</span></span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (entity.downloadTask == <span class="literal">null</span>) &#123;</span><br><span class="line">                    entity.downloadTask = task</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">val</span> preOffset = (task.getTag(CURRENT_PROGRESS) <span class="keyword">as</span> <span class="built_in">Long</span>?) ?: <span class="number">0</span></span><br><span class="line">                speedCalculator.downloading(currentOffset - preOffset)</span><br><span class="line">                entity.currentSize = currentOffset</span><br><span class="line">                <span class="keyword">val</span> now = System.currentTimeMillis()</span><br><span class="line">                <span class="keyword">if</span> (now - lastCallback &gt; <span class="number">1000</span>) &#123;</span><br><span class="line">                    entity.currentProgress = (currentOffset * <span class="number">1.0</span>) / (totalLength * <span class="number">1.0</span>)</span><br><span class="line">                    entity.currentSpeed = speedCalculator.speed() ?: <span class="string">""</span></span><br><span class="line">                    entity.status = DOWNLOADING</span><br><span class="line">                    entity.toFile()</span><br><span class="line">                    FileDownloader.downloadCallback.postValue(entity)</span><br><span class="line">                    lastCallback = now</span><br><span class="line">                &#125;</span><br><span class="line">                task.addTag(CURRENT_PROGRESS, currentOffset)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">connected</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">                task: <span class="type">DownloadTask</span>, blockCount: <span class="type">Int</span>, currentOffset: <span class="type">Long</span>, totalLength: <span class="type">Long</span></span></span></span><br><span class="line"><span class="function"><span class="params">            )</span></span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (entity.downloadTask == <span class="literal">null</span>) &#123;</span><br><span class="line">                    entity.downloadTask = task</span><br><span class="line">                &#125;</span><br><span class="line">                entity.currentSize += currentOffset</span><br><span class="line">                entity.fileSize += totalLength</span><br><span class="line">                entity.toFile()</span><br><span class="line">                FileDownloader.downloadCallback.postValue(entity)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">retry</span><span class="params">(task: <span class="type">DownloadTask</span>, cause: <span class="type">ResumeFailedCause</span>)</span></span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (entity.downloadTask == <span class="literal">null</span>) &#123;</span><br><span class="line">                    entity.downloadTask = task</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        entity.downloadTask = task</span><br><span class="line">        downloadList.add(entity.originalUrl)</span><br><span class="line">        FileDownloader.addUseProgress(entity.originalUrl)<span class="comment">//已使用的线程数增加</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="多任务管理"><a href="#多任务管理" class="headerlink" title="多任务管理"></a>多任务管理</h2><p>以上代码出现了不少的<code>FileDownloader</code>这个类，这个类的主要作用是进行多任务的管理，实现顺序任务下载，限制同时下载数量等功能，具体代码如下：<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> FileDownloader &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> TAG = <span class="string">"FileDownloader"</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> downloadCallback = MutableLiveData&lt;VideoDownloadEntity&gt;()<span class="comment">//下载进度回调</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> MAX_PROGRESS = -<span class="number">1</span></span><br><span class="line">        <span class="comment">//最终计算结果至少为1</span></span><br><span class="line">        <span class="keyword">get</span>() &#123;</span><br><span class="line">            <span class="keyword">if</span> (field == -<span class="number">1</span>) &#123;</span><br><span class="line">                field = Runtime.getRuntime().availableProcessors() / <span class="number">2</span><span class="comment">//可用线程数的一半</span></span><br><span class="line">                <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; <span class="number">23</span>) &#123;<span class="comment">//如果小于Android6的，可用线程数再减2</span></span><br><span class="line">                    field -= <span class="number">2</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (field &gt; <span class="number">5</span>) &#123;<span class="comment">//最多只能有5个并行</span></span><br><span class="line">                field = <span class="number">5</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (field &lt;= <span class="number">0</span>) &#123;<span class="comment">//最少也要有1个任务</span></span><br><span class="line">                field = <span class="number">1</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> field</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> useProgress = <span class="number">0</span></span><br><span class="line">        <span class="comment">//已使用的线程数,始终大于0</span></span><br><span class="line">        <span class="keyword">set</span>(value) &#123;</span><br><span class="line">            <span class="keyword">if</span> (value &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                field = value</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> downloadingList = arrayListOf&lt;String&gt;()<span class="comment">//下载中的列表，为统计线程使用</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> waitDownloadList = arrayListOf&lt;String&gt;()<span class="comment">//等待下载的url列表</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> downloadList = arrayListOf&lt;VideoDownloadEntity&gt;()<span class="comment">//排队列表</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> waitList = arrayListOf&lt;VideoDownloadEntity&gt;()<span class="comment">//等待下载的队列</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> wait = <span class="literal">false</span><span class="comment">//m3u8等待状态</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 停止全部任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">clearAllDownload</span><span class="params">()</span></span> &#123;</span><br><span class="line">        OkDownload.with().downloadDispatcher().cancelAll()</span><br><span class="line">        downloadingList.clear()</span><br><span class="line">        waitDownloadList.clear()</span><br><span class="line">        downloadList.clear()</span><br><span class="line">        waitList.clear()</span><br><span class="line">        M3U8ConfigDownloader.clear()</span><br><span class="line">        M3U8Downloader.clear()</span><br><span class="line">        SingleVideoDownloader.clear()</span><br><span class="line">        MAX_PROGRESS = -<span class="number">1</span></span><br><span class="line">        useProgress = <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 减少已使用线程数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">subUseProgress</span><span class="params">(url: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (downloadingList.contains(url)) &#123;</span><br><span class="line">            useProgress--</span><br><span class="line">            downloadingList.remove(url)</span><br><span class="line">            Log.d(TAG, <span class="string">"释放线程---<span class="variable">$useProgress</span>"</span>)</span><br><span class="line">            <span class="keyword">if</span> (downloadList.isNotEmpty()) &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">"subUseProgress---新增任务"</span>)</span><br><span class="line">                waitDownloadList.removeAt(<span class="number">0</span>)</span><br><span class="line">                downloadVideo(downloadList.removeAt(<span class="number">0</span>))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增加使用线程数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">addUseProgress</span><span class="params">(url: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!downloadingList.contains(url)) &#123;</span><br><span class="line">            useProgress++</span><br><span class="line">            downloadingList.add(url)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取最顶层的下载目录</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JvmStatic</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getBaseDownloadPath</span><span class="params">()</span></span>: File &#123;</span><br><span class="line">        <span class="keyword">val</span> file = File(Environment.getExternalStorageDirectory(), <span class="string">"m3u8Downloader"</span>)</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            file.mkdirs()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> file</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取根据链接得到的下载存储路径</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JvmStatic</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getDownloadPath</span><span class="params">(url: <span class="type">String</span>)</span></span>: File &#123;</span><br><span class="line">        <span class="keyword">val</span> file = File(getBaseDownloadPath(), md5(url))</span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123;</span><br><span class="line">            file.mkdir()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> file</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取相关配置文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JvmStatic</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getConfigFile</span><span class="params">(url: <span class="type">String</span>)</span></span>: File &#123;</span><br><span class="line">        <span class="keyword">val</span> path = getDownloadPath(url)</span><br><span class="line">        <span class="keyword">return</span> File(path, <span class="string">"video.config"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取相关配置文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JvmStatic</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getConfigFile</span><span class="params">(path: <span class="type">File</span>)</span></span>: File &#123;</span><br><span class="line">        <span class="keyword">return</span> File(path, <span class="string">"video.config"</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下载的入口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JvmStatic</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">downloadVideo</span><span class="params">(entity: <span class="type">VideoDownloadEntity</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (entity.status == DELETE) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (entity.originalUrl.endsWith(<span class="string">".m3u8"</span>)) &#123;</span><br><span class="line">            downloadM3U8File(entity)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            downloadSingleVideo(entity)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 下载但文件入口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JvmStatic</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">downloadSingleVideo</span><span class="params">(entity: <span class="type">VideoDownloadEntity</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (entity.status == DELETE) &#123;<span class="comment">//删除状态的忽略</span></span><br><span class="line">            Log.d(TAG, <span class="string">"downloadSingleVideo---DELETE"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (useProgress &lt; MAX_PROGRESS) &#123;<span class="comment">//还有可用的线程数</span></span><br><span class="line">            SingleVideoDownloader.fileDownloader(entity)<span class="comment">//进入下载</span></span><br><span class="line">            Log.d(TAG, <span class="string">"-----useProgress===&gt;<span class="variable">$useProgress</span>"</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">//没有可用线程的时候就添加到等待队列</span></span><br><span class="line">            SingleVideoDownloader.initConfig(entity)<span class="comment">//初始化一下下载任务</span></span><br><span class="line">            <span class="comment">//不是下载中的内容,且没有在等待</span></span><br><span class="line">            <span class="keyword">if</span> (!downloadingList.contains(entity.originalUrl) &amp;&amp; !waitDownloadList.contains(entity.originalUrl)) &#123;</span><br><span class="line">                downloadList.add(entity)</span><br><span class="line">                waitDownloadList.add(entity.originalUrl)</span><br><span class="line">                Log.d(TAG, <span class="string">"addDownloadList---<span class="subst">$&#123;entity.originalUrl&#125;</span>"</span>)</span><br><span class="line">                entity.status = PREPARE</span><br><span class="line">                downloadCallback.postValue(entity)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (entity.status == NO_START || entity.status == ERROR || entity.status == PAUSE) &#123;</span><br><span class="line">                    <span class="comment">//如果要下载的内容是等待中的，但是状态还没有修正过来，则修正状态</span></span><br><span class="line">                    entity.status = PREPARE</span><br><span class="line">                    downloadCallback.postValue(entity)</span><br><span class="line">                &#125;</span><br><span class="line">                Log.d(TAG, <span class="string">"下载中或等待中的文件"</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JvmStatic</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">downloadM3U8File</span><span class="params">(entity: <span class="type">VideoDownloadEntity</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (entity.status == DELETE) &#123;<span class="comment">//删除状态的忽略</span></span><br><span class="line">            Log.d(TAG, <span class="string">"downloadM3U8File---DELETE"</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        Log.d(TAG, <span class="string">"<span class="variable">$wait</span>--downloadM3U8File--<span class="subst">$&#123;entity.originalUrl&#125;</span>"</span>)</span><br><span class="line">        thread &#123;</span><br><span class="line">            <span class="keyword">if</span> (wait) &#123;<span class="comment">//如果有在获取真实ts的内容则添加到等待队列</span></span><br><span class="line">                Log.d(TAG, <span class="string">"addWaiting"</span>)</span><br><span class="line">                waitList.add(entity)</span><br><span class="line">                <span class="keyword">return</span><span class="symbol">@thread</span></span><br><span class="line">            &#125;</span><br><span class="line">            wait = <span class="literal">true</span></span><br><span class="line">            <span class="keyword">val</span> file = M3U8ConfigDownloader.start(entity)<span class="comment">//准备下载列表</span></span><br><span class="line">            <span class="keyword">if</span> (useProgress &lt; MAX_PROGRESS) &#123;<span class="comment">//还有可用的线程数</span></span><br><span class="line">                <span class="keyword">if</span> (file != <span class="literal">null</span>) &#123;<span class="comment">//需要下载</span></span><br><span class="line">                    <span class="keyword">var</span> times = <span class="number">50</span></span><br><span class="line">                    Log.d(TAG, <span class="string">"file.exists()==&gt;<span class="subst">$&#123;file.exists()&#125;</span>"</span>)</span><br><span class="line">                    <span class="keyword">while</span> (!file.exists() &amp;&amp; times &gt; <span class="number">0</span>) &#123;<span class="comment">//如果文件还不存在则等待100ms</span></span><br><span class="line">                        Log.d(TAG, <span class="string">"waiting..."</span>)</span><br><span class="line">                        Thread.sleep(<span class="number">100</span>)</span><br><span class="line">                        times--</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (file.exists()) &#123;<span class="comment">//如果文件存在了则开始下载</span></span><br><span class="line">                        M3U8Downloader.bunchDownload(getDownloadPath(entity.originalUrl))</span><br><span class="line">                    &#125;</span><br><span class="line">                    Log.d(TAG, <span class="string">"<span class="subst">$&#123;file.exists()&#125;</span>-----useProgress===&gt;<span class="variable">$useProgress</span>"</span>)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Log.d(TAG, <span class="string">"file===null"</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;<span class="comment">//没有可用线程的时候就添加到等待队列</span></span><br><span class="line">                <span class="comment">//不是下载中的内容,且没有在等待</span></span><br><span class="line">                <span class="keyword">if</span> (!downloadingList.contains(entity.originalUrl) &amp;&amp;</span><br><span class="line">                    !waitDownloadList.contains(entity.originalUrl)</span><br><span class="line">                ) &#123;<span class="comment">//添加到任务队列</span></span><br><span class="line">                    downloadList.add(entity)</span><br><span class="line">                    waitDownloadList.add(entity.originalUrl)</span><br><span class="line">                    Log.d(TAG, <span class="string">"addDownloadList---<span class="subst">$&#123;entity.originalUrl&#125;</span>"</span>)</span><br><span class="line">                    entity.status = PREPARE</span><br><span class="line">                    downloadCallback.postValue(entity)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    Log.d(TAG, <span class="string">"下载中或等待中的文件"</span>)</span><br><span class="line">                    <span class="keyword">if</span> (entity.status == NO_START || entity.status == ERROR || entity.status == PAUSE) &#123;</span><br><span class="line">                        <span class="comment">//如果要下载的内容是等待中的，但是状态还没有修正过来，则修正状态</span></span><br><span class="line">                        entity.status = PREPARE</span><br><span class="line">                        downloadCallback.postValue(entity)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            wait = <span class="literal">false</span></span><br><span class="line">            <span class="keyword">if</span> (waitList.isNotEmpty()) &#123;</span><br><span class="line">                <span class="comment">//有等待获取真实ts流的则继续回调</span></span><br><span class="line">                Log.d(TAG, <span class="string">"removeWaiting"</span>)</span><br><span class="line">                downloadM3U8File(waitList.removeAt(<span class="number">0</span>))</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="使用测试"><a href="#使用测试" class="headerlink" title="使用测试"></a>使用测试</h2><p>编写完下载库，下面就进行测试了</p>
<h3 id="下载列表的item"><a href="#下载列表的item" class="headerlink" title="下载列表的item"></a>下载列表的item</h3><p><img src="/blog_images/m3u8Downloader_1.png" alt="item"><br>具体代码如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:paddingStart</span>=<span class="string">"15dp"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:paddingTop</span>=<span class="string">"8dp"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:paddingEnd</span>=<span class="string">"15dp"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:paddingBottom</span>=<span class="string">"8dp"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/download"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@drawable/shape_download_prepare"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:paddingStart</span>=<span class="string">"15dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:paddingTop</span>=<span class="string">"5dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:paddingEnd</span>=<span class="string">"15dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:paddingBottom</span>=<span class="string">"5dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"@string/btn_download"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:textColor</span>=<span class="string">"@color/blue"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:textSize</span>=<span class="string">"12sp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/title"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginStart</span>=<span class="string">"15dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:ellipsize</span>=<span class="string">"end"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:maxLines</span>=<span class="string">"1"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:textSize</span>=<span class="string">"18sp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toStartOf</span>=<span class="string">"@id/download"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:text</span>=<span class="string">"@string/app_name"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/current_size"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">"5dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:textSize</span>=<span class="string">"12sp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">"@id/title"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/title"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:text</span>=<span class="string">"201.37MB"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/speed"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginStart</span>=<span class="string">"15dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:textSize</span>=<span class="string">"12sp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"@id/current_size"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toEndOf</span>=<span class="string">"@id/current_size"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:text</span>=<span class="string">"90.5%|251.37kB/s"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/url"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:ellipsize</span>=<span class="string">"end"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:maxLines</span>=<span class="string">"2"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintEnd_toEndOf</span>=<span class="string">"parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">"@id/title"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/speed"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">tools:text</span>=<span class="string">"https://qq.com-ok-qq.com/20191015/24619_fc6ad1d6/index.m3u8"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="Adapter的编写"><a href="#Adapter的编写" class="headerlink" title="Adapter的编写"></a>Adapter的编写</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">VideoDownloadAdapter</span></span>(<span class="keyword">private</span> <span class="keyword">val</span> list: MutableList&lt;VideoDownloadEntity&gt;) :</span><br><span class="line">    RecyclerView.Adapter&lt;VideoDownloadAdapter.ViewHolder&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateViewHolder</span><span class="params">(parent: <span class="type">ViewGroup</span>, viewType: <span class="type">Int</span>)</span></span>: ViewHolder &#123;</span><br><span class="line">        <span class="keyword">return</span> ViewHolder(</span><br><span class="line">            LayoutInflater.from(parent.context).inflate(</span><br><span class="line">                R.layout.item_download_list, parent, <span class="literal">false</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getItemCount</span><span class="params">()</span></span> = list.size</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 避免出现整个item闪烁</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBindViewHolder</span><span class="params">(holder: <span class="type">ViewHolder</span>, position: <span class="type">Int</span>, payloads: <span class="type">MutableList</span>&lt;<span class="type">Any</span>&gt;)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (payloads.isNullOrEmpty()) &#123;</span><br><span class="line">            <span class="keyword">super</span>.onBindViewHolder(holder, position, payloads)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            holder.updateProgress(list[position])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBindViewHolder</span><span class="params">(holder: <span class="type">ViewHolder</span>, position: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        holder.setData(list[position])</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ViewHolder</span></span>(<span class="keyword">private</span> <span class="keyword">val</span> view: View) : RecyclerView.ViewHolder(view) &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> title = view.findViewById&lt;TextView&gt;(R.id.title)</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> currentSize = view.findViewById&lt;TextView&gt;(R.id.current_size)</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> speed = view.findViewById&lt;TextView&gt;(R.id.speed)</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> url = view.findViewById&lt;TextView&gt;(R.id.url)</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> download = view.findViewById&lt;TextView&gt;(R.id.download)</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 设置数据</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@SuppressLint(<span class="meta-string">"SetTextI18n"</span>)</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">setData</span><span class="params">(<span class="keyword">data</span>: <span class="type">VideoDownloadEntity</span>?)</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">data</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">val</span> context = view.context</span><br><span class="line">            url.text = <span class="keyword">data</span>.originalUrl</span><br><span class="line">            <span class="keyword">val</span> name = <span class="keyword">if</span> (<span class="keyword">data</span>.name.isNotEmpty()) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">data</span>.subName.isNotEmpty()) &#123;</span><br><span class="line">                    <span class="string">"<span class="subst">$&#123;data.name&#125;</span>(<span class="subst">$&#123;data.subName&#125;</span>)"</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">data</span>.name</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">data</span>.subName.isNotEmpty()) &#123;</span><br><span class="line">                    <span class="string">"<span class="subst">$&#123;context.getString(R.string.unknow_movie)&#125;</span>(<span class="subst">$&#123;data.subName&#125;</span>)"</span></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    context.getString(R.string.unknow_movie)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            title.text = name</span><br><span class="line">            updateProgress(<span class="keyword">data</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 进度更新</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@SuppressLint(<span class="meta-string">"SetTextI18n"</span>)</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">updateProgress</span><span class="params">(<span class="keyword">data</span>: <span class="type">VideoDownloadEntity</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">data</span>.originalUrl.endsWith(<span class="string">".m3u8"</span>) || <span class="keyword">data</span>.status == COMPLETE) &#123;</span><br><span class="line">                currentSize.text =</span><br><span class="line">                    getSizeUnit(<span class="keyword">data</span>.currentSize.toDouble())</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                currentSize.text =</span><br><span class="line">                    <span class="string">"<span class="subst">$&#123;getSizeUnit(data.currentSize.toDouble())&#125;</span>/<span class="subst">$&#123;getSizeUnit(</span></span></span><br><span class="line"><span class="string"><span class="subst">                        data.fileSize.toDouble()</span></span></span><br><span class="line"><span class="string"><span class="subst">                    )&#125;</span>"</span></span><br><span class="line">            &#125;</span><br><span class="line">            speed.text =</span><br><span class="line">                <span class="string">"<span class="subst">$&#123;DecimalFormat("#.##%").format(data.currentProgress)&#125;</span>|<span class="subst">$&#123;data.currentSpeed&#125;</span>"</span></span><br><span class="line">            <span class="keyword">val</span> context = view.context</span><br><span class="line">            <span class="comment">//状态逻辑处理</span></span><br><span class="line">            <span class="keyword">when</span> (<span class="keyword">data</span>.status) &#123;</span><br><span class="line">                NO_START -&gt; &#123;</span><br><span class="line">                    download.setTextColor(ContextCompat.getColor(context, R.color.blue))</span><br><span class="line">                    download.background =</span><br><span class="line">                        ContextCompat.getDrawable(context, R.drawable.shape_download_prepare)</span><br><span class="line">                    download.setText(R.string.btn_download)</span><br><span class="line">                    download.isVisible = <span class="literal">true</span></span><br><span class="line">                    speed.isVisible = <span class="literal">false</span></span><br><span class="line">                    currentSize.isVisible = <span class="literal">false</span></span><br><span class="line">                    currentSize.setText(R.string.wait_download)</span><br><span class="line">                    download.setOnClickListener &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">data</span>.startDownload != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">data</span>.startDownload!!.invoke()</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            FileDownloader.downloadVideo(<span class="keyword">data</span>)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                DOWNLOADING -&gt; &#123;</span><br><span class="line">                    currentSize.isVisible = <span class="literal">true</span></span><br><span class="line">                    speed.isVisible = <span class="literal">true</span></span><br><span class="line">                    speed.setTextColor(ContextCompat.getColor(speed.context, R.color.blue))</span><br><span class="line">                    download.isVisible = <span class="literal">true</span></span><br><span class="line">                    download.setText(R.string.pause)</span><br><span class="line">                    download.setOnClickListener &#123;</span><br><span class="line">                        <span class="keyword">data</span>.downloadContext?.stop()</span><br><span class="line">                        <span class="keyword">data</span>.downloadTask?.cancel()</span><br><span class="line">                    &#125;</span><br><span class="line">                    download.setTextColor(ContextCompat.getColor(context, R.color.white))</span><br><span class="line">                    download.background =</span><br><span class="line">                        ContextCompat.getDrawable(context, R.drawable.shape_blue_btn)</span><br><span class="line">                &#125;</span><br><span class="line">                PAUSE -&gt; &#123;</span><br><span class="line">                    currentSize.isVisible = <span class="literal">true</span></span><br><span class="line">                    download.setTextColor(ContextCompat.getColor(context, R.color.white))</span><br><span class="line">                    download.background =</span><br><span class="line">                        ContextCompat.getDrawable(context, R.drawable.shape_blue_btn)</span><br><span class="line">                    download.isVisible = <span class="literal">true</span></span><br><span class="line">                    download.setText(R.string.go_on)</span><br><span class="line">                    download.setOnClickListener &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">data</span>.startDownload != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">data</span>.startDownload!!.invoke()</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            FileDownloader.downloadVideo(<span class="keyword">data</span>)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    speed.isVisible = <span class="literal">true</span></span><br><span class="line">                    speed.setText(R.string.already_paused)</span><br><span class="line">                    speed.setTextColor(ContextCompat.getColor(speed.context, R.color.red))</span><br><span class="line">                &#125;</span><br><span class="line">                COMPLETE -&gt; &#123;</span><br><span class="line">                    currentSize.isVisible = <span class="literal">true</span></span><br><span class="line">                    download.isVisible = <span class="literal">false</span></span><br><span class="line">                    speed.isVisible = <span class="literal">false</span></span><br><span class="line">                &#125;</span><br><span class="line">                PREPARE -&gt; &#123;</span><br><span class="line">                    currentSize.isVisible = <span class="literal">true</span></span><br><span class="line">                    download.setText(R.string.prepareing)</span><br><span class="line">                    currentSize.setText(R.string.wait_download)</span><br><span class="line">                    download.isVisible = <span class="literal">true</span></span><br><span class="line">                    download.setOnClickListener &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">data</span>.startDownload != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">data</span>.startDownload!!.invoke()</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            FileDownloader.downloadVideo(<span class="keyword">data</span>)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    download.setTextColor(ContextCompat.getColor(context, R.color.blue))</span><br><span class="line">                    download.background =</span><br><span class="line">                        ContextCompat.getDrawable(context, R.drawable.shape_download_prepare)</span><br><span class="line">                    speed.isVisible = <span class="literal">false</span></span><br><span class="line">                &#125;</span><br><span class="line">                ERROR -&gt; &#123;</span><br><span class="line">                    currentSize.isVisible = <span class="literal">false</span></span><br><span class="line">                    speed.isVisible = <span class="literal">false</span></span><br><span class="line">                    download.isVisible = <span class="literal">true</span></span><br><span class="line">                    download.setText(R.string.retry)</span><br><span class="line">                    download.setOnClickListener &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">data</span>.startDownload != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">data</span>.startDownload!!.invoke()</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            FileDownloader.downloadVideo(<span class="keyword">data</span>)</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    download.setTextColor(ContextCompat.getColor(context, R.color.white))</span><br><span class="line">                    download.background =</span><br><span class="line">                        ContextCompat.getDrawable(context, R.drawable.shape_blue_btn)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于是下载列表，如果频繁刷新是会导致整个item不断闪烁的，所以在下载库那边也有处理了1秒钟才发出一次进度更新，而在接收的时候一定要注意，需要重写<code>onBindViewHolder(holder: ViewHolder, position: Int, payloads: MutableList&lt;Any&gt;)</code>这个函数，通知adapter更新的时候应该调用<code>notifyItemChanged(int position, @Nullable Object payload)</code>这样可以避免整个item闪烁，实现只更新局部控件的效果</p>
<h3 id="Activity的实现"><a href="#Activity的实现" class="headerlink" title="Activity的实现"></a>Activity的实现</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RuntimePermissions</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> : <span class="type">AppCompatActivity</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> adapter: VideoDownloadAdapter</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> videoList = arrayListOf&lt;VideoDownloadEntity&gt;()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> tempList = arrayListOf&lt;String&gt;()</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> gson = GsonBuilder().create()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_main)</span><br><span class="line">        initListView()</span><br><span class="line">        initListWithPermissionCheck()</span><br><span class="line">        <span class="comment">//接收进度通知</span></span><br><span class="line">        FileDownloader.downloadCallback.observe(<span class="keyword">this</span>, Observer &#123;</span><br><span class="line">            onProgress(it)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">//新建下载</span></span><br><span class="line">        add.setOnClickListener &#123;</span><br><span class="line">            newDownload()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initListView</span><span class="params">()</span></span> &#123;</span><br><span class="line">        adapter = VideoDownloadAdapter(videoList)</span><br><span class="line">        list.adapter = adapter</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NeedsPermission(</span></span><br><span class="line"><span class="meta">        Manifest.permission.READ_EXTERNAL_STORAGE,</span></span><br><span class="line"><span class="meta">        Manifest.permission.WRITE_EXTERNAL_STORAGE</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">initList</span><span class="params">()</span></span> &#123;</span><br><span class="line">        thread &#123;<span class="comment">//在线程中处理，防止ANR</span></span><br><span class="line">            FileDownloader.getBaseDownloadPath().listFiles().forEach &#123;</span><br><span class="line">                <span class="keyword">val</span> file = File(it, <span class="string">"video.config"</span>)</span><br><span class="line">                <span class="keyword">if</span> (file.exists()) &#123;</span><br><span class="line">                    <span class="keyword">val</span> text = file.readText()</span><br><span class="line">                    <span class="keyword">if</span> (text.isNotEmpty()) &#123;</span><br><span class="line">                        <span class="keyword">val</span> <span class="keyword">data</span> = gson.fromJson&lt;VideoDownloadEntity&gt;(</span><br><span class="line">                            text,</span><br><span class="line">                            VideoDownloadEntity::<span class="class"><span class="keyword">class</span>.<span class="title">java</span></span></span><br><span class="line">                        )</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">data</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="keyword">if</span> (<span class="keyword">data</span>.status == DELETE) &#123;</span><br><span class="line">                                it.deleteRecursively()</span><br><span class="line">                            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!tempList.contains(<span class="keyword">data</span>.originalUrl)) &#123;</span><br><span class="line">                                videoList.add(<span class="keyword">data</span>)</span><br><span class="line">                                tempList.add(<span class="keyword">data</span>.originalUrl)</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            runOnUiThread &#123;</span><br><span class="line">                <span class="comment">//主线程通知刷新布局</span></span><br><span class="line">                adapter.notifyDataSetChanged()</span><br><span class="line">            &#125;</span><br><span class="line">            videoList.sort()</span><br><span class="line">            <span class="comment">//依次添加下载队列</span></span><br><span class="line">            videoList.filter &#123; it.status == DOWNLOADING &#125;.forEach &#123;</span><br><span class="line">                FileDownloader.downloadVideo(it)</span><br><span class="line">            &#125;</span><br><span class="line">            videoList.filter &#123; it.status == PREPARE &#125;.forEach &#123;</span><br><span class="line">                FileDownloader.downloadVideo(it)</span><br><span class="line">            &#125;</span><br><span class="line">            videoList.filter &#123; it.status == NO_START &#125;.forEach &#123;</span><br><span class="line">                FileDownloader.downloadVideo(it)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnPermissionDenied(</span></span><br><span class="line"><span class="meta">        Manifest.permission.READ_EXTERNAL_STORAGE,</span></span><br><span class="line"><span class="meta">        Manifest.permission.WRITE_EXTERNAL_STORAGE</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">onDenied</span><span class="params">()</span></span> &#123;</span><br><span class="line">        toast(R.string.need_permission_tips)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">toast</span><span class="params">(<span class="meta">@StringRes</span> msg: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        Toast.makeText(<span class="keyword">this</span>, msg, Toast.LENGTH_LONG).show()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onRequestPermissionsResult</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        requestCode: <span class="type">Int</span>, permissions: <span class="type">Array</span>&lt;<span class="type">out</span> <span class="type">String</span>&gt;, grantResults: <span class="type">IntArray</span></span></span></span><br><span class="line"><span class="function"><span class="params">    )</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults)</span><br><span class="line">        onRequestPermissionsResult(requestCode, grantResults)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">onProgress</span><span class="params">(entity: <span class="type">VideoDownloadEntity</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> ((index, item) <span class="keyword">in</span> videoList.withIndex()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (item.originalUrl == entity.originalUrl) &#123;</span><br><span class="line">                videoList[index].status = entity.status</span><br><span class="line">                videoList[index].currentSize = entity.currentSize</span><br><span class="line">                videoList[index].currentSpeed = entity.currentSpeed</span><br><span class="line">                videoList[index].currentProgress = entity.currentProgress</span><br><span class="line">                videoList[index].fileSize = entity.fileSize</span><br><span class="line">                videoList[index].tsSize = entity.tsSize</span><br><span class="line">                videoList[index].downloadContext = entity.downloadContext</span><br><span class="line">                videoList[index].downloadTask = entity.downloadTask</span><br><span class="line">                videoList[index].startDownload = entity.startDownload</span><br><span class="line">                adapter.notifyItemChanged(index, <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">newDownload</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> editText = EditText(<span class="keyword">this</span>)</span><br><span class="line">        editText.setHint(R.string.please_input_download_address)</span><br><span class="line">        <span class="keyword">val</span> downloadDialog = AlertDialog.Builder(<span class="keyword">this</span>)</span><br><span class="line">            .setView(editText)</span><br><span class="line">            .setTitle(R.string.new_download)</span><br><span class="line">            .setPositiveButton(R.string.ok) &#123; dialog, _ -&gt;</span><br><span class="line">                <span class="keyword">if</span> (editText.text.isNullOrEmpty()) &#123;</span><br><span class="line">                    toast(R.string.please_input_download_address)</span><br><span class="line">                    <span class="keyword">return</span><span class="symbol">@setPositiveButton</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">val</span> url = editText.text.toString()</span><br><span class="line">                <span class="keyword">if</span> (tempList.contains(url)) &#123;</span><br><span class="line">                    toast(R.string.already_download)</span><br><span class="line">                    dialog.dismiss()</span><br><span class="line">                    <span class="keyword">return</span><span class="symbol">@setPositiveButton</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">val</span> name = <span class="keyword">if</span> (url.contains(<span class="string">"?"</span>)) &#123;</span><br><span class="line">                    url.substring(url.lastIndexOf(<span class="string">"/"</span>) + <span class="number">1</span>, url.indexOf(<span class="string">"?"</span>))</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    url.substring(url.lastIndexOf(<span class="string">"/"</span>) + <span class="number">1</span>)</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">val</span> entity = VideoDownloadEntity(url, name)</span><br><span class="line">                entity.toFile()</span><br><span class="line">                videoList.add(<span class="number">0</span>, entity)</span><br><span class="line">                adapter.notifyItemInserted(<span class="number">0</span>)</span><br><span class="line">                FileDownloader.downloadVideo(entity)</span><br><span class="line">            &#125;</span><br><span class="line">            .setNegativeButton(R.string.cancle) &#123; dialog, _ -&gt;</span><br><span class="line">                dialog.dismiss()</span><br><span class="line">            &#125;.create()</span><br><span class="line">        downloadDialog.show()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
                <div class="post-copyright">
    <div class="content">
        <p>最后更新： 2019年10月25日 18:58</p>
        <p>原始链接：
            
                <a class="post-url" href="/essay/M3U8视频下载实现/" title="M3U8视频下载实现">https://blog.it9.top/essay/M3U8视频下载实现/</a>
            
        </p>
        <footer>
            <a href="https://blog.it9.top">
                <img src="/images/logo.jpeg" alt="IT Go">
                IT Go
            </a>
        </footer>
    </div>
</div>

                
                
                
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;">赏</a>
</div>

<div id="reward" class="post-modal reward-lay">
    <a class="close" href="javascript:;" id="reward-close">×</a>
    <span class="reward-title">
        <i class="icon icon-quote-left"></i>
        请我吃糖~
        <i class="icon icon-quote-right"></i>
    </span>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/images/wechat_code.png" alt="打赏二维码">
        </div>
        <div class="reward-select">
            
            <label class="reward-select-item checked" data-id="wechat" data-wechat="/images/wechat_code.png">
                <img class="reward-select-item-wechat" src="/images/wechat.png" alt="微信">
            </label>
            
            
            <label class="reward-select-item" data-id="alipay" data-alipay="/images/alipay_code.png">
                <img class="reward-select-item-alipay" src="/images/alipay.png" alt="支付宝">
            </label>
            
        </div>
    </div>
</div>


                
            </div>
            <footer class="article-footer">
                
                
<div class="post-share">
    <a href="javascript:;" id="share-sub" class="post-share-fab">
        <i class="fa fa-share-alt"></i>
    </a>
    <div class="post-share-list" id="share-list">
        <ul class="share-icons">
          <li>
            <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.it9.top/essay/M3U8视频下载实现/&title=《M3U8视频下载实现》 — IT Go&pic=/blog_images/m3u8Downloader_0.png" data-title="微博">
              <i class="fa fa-weibo"></i>
            </a>
          </li>
          <li>
            <a class="weixin share-sns" id="wxFab" href="javascript:;" data-title="微信">
              <i class="fa fa-weixin"></i>
            </a>
          </li>
          <li>
            <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.it9.top/essay/M3U8视频下载实现/&title=《M3U8视频下载实现》 — IT Go&source=瞎搞事，瞎折腾，瞎扯淡" data-title="QQ">
              <i class="fa fa-qq"></i>
            </a>
          </li>
          <li>
            <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.it9.top/essay/M3U8视频下载实现/" data-title="Facebook">
              <i class="fa fa-facebook"></i>
            </a>
          </li>
          <li>
            <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《M3U8视频下载实现》 — IT Go&url=https://blog.it9.top/essay/M3U8视频下载实现/&via=https://blog.it9.top" data-title="Twitter">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
          <li>
            <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.it9.top/essay/M3U8视频下载实现/" data-title="Google+">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        </ul>
     </div>
</div>
<div class="post-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;" id="wxShare-close">×</a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=https://blog.it9.top/essay/M3U8视频下载实现/" alt="微信分享二维码">
</div>

<div class="mask"></div>

                
                <ul class="article-footer-menu">
                    
                    
  <li class="article-footer-tags">
    <i class="fa fa-tags"></i>
      
    <a href="/tags/android/" class="color3">Android</a>
      
  </li>

                </ul>
                
            </footer>
        </div>
</article>


    <aside class="post-toc-pos post-toc-top" id="post-toc">
        <nav class="post-toc-wrap">
            <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#M3U8文件结构"><span class="post-toc-text">M3U8文件结构</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#最直接的m3u8文件"><span class="post-toc-text">最直接的m3u8文件</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#需要重定向的m3u8"><span class="post-toc-text">需要重定向的m3u8</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#ts文件分析"><span class="post-toc-text">ts文件分析</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#技术选型"><span class="post-toc-text">技术选型</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#代码实现"><span class="post-toc-text">代码实现</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#数据类型准备"><span class="post-toc-text">数据类型准备</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#获取真实ts路径"><span class="post-toc-text">获取真实ts路径</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#下载ts文件"><span class="post-toc-text">下载ts文件</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#MP4下载"><span class="post-toc-text">MP4下载</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#多任务管理"><span class="post-toc-text">多任务管理</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#使用测试"><span class="post-toc-text">使用测试</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#下载列表的item"><span class="post-toc-text">下载列表的item</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Adapter的编写"><span class="post-toc-text">Adapter的编写</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Activity的实现"><span class="post-toc-text">Activity的实现</span></a></li></ol></li></ol>
        </nav>
    </aside>
    

<nav id="article-nav">
  
    <a href="/note/M3U8合并最简单的方法/" id="article-nav-newer" class="article-nav-link-wrap">

      <span class="article-nav-title">
        <i class="fa fa-hand-o-left" aria-hidden="true"></i>
        
          M3U8合并最简单的方法
        
      </span>
    </a>
  
  
    <a href="/essay/GSYVideoPlayer 视频缓存部分源码解析/" id="article-nav-older" class="article-nav-link-wrap">
      <span class="article-nav-title">GSYVideoPlayer 视频缓存简单源码解析</span>
      <i class="fa fa-hand-o-right" aria-hidden="true"></i>
    </a>
  
</nav>




<div id="SOHUCS" sid="M3U8视频下载实现"></div>
<script type="text/javascript">
    (function(){
        var appid = 'cytXViG69';
        var conf = 'prod_ec256658191d4702179ffc2efd670f6d';
        var width = window.innerWidth || document.documentElement.clientWidth;
        if (width < 960) {
            window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>

</section>
        
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
      
<p>
    <span id="busuanzi_container_site_uv" style="display:none">
        总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style="display:none">
        总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


      <p>
        Copyright &copy; 2019, All Rights Reserved.
      <br>Powered by  <a href="http://hexo.io/" target="_blank">Hexo</a>
        Theme <a href="https://github.com/wongminho/hexo-theme-miho" target="_blank">MiHo</a>
         change by <a href="mailto:xuqingquan1995@gmail.com" target="_blank"> IT Go</a>
         <br>闽ICP备17032899号-1
      </p>
    </div>
  </div>
</footer>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script>
  var mihoConfig = {
      root: "https://blog.it9.top",
      animate: true,
      isHome: false,
      share: true,
      reward: 1
  }
</script>
<div class="sidebar">
    <div id="sidebar-search" title="Search">
        <i class="fa fa-search"></i>
    </div>
    <div id="sidebar-category" title="Categories">
        <i class="fa fa-book"></i>
    </div>
    <div id="sidebar-tag" title="Tags">
        <i class="fa fa-tags"></i>
    </div>
    <div id="sidebar-top">
        <span class="sidebar-top-icon"><i class="fa fa-angle-up"></i></span>
    </div>
</div>
<div class="sidebar-menu-box" id="sidebar-menu-box">
    <div class="sidebar-menu-box-container">
        <div id="sidebar-menu-box-categories">
            <a class="category-link" href="/categories/note/">小知识</a><a class="category-link" href="/categories/essay/">随笔</a>
        </div>
        <div id="sidebar-menu-box-tags">
            <a href="/tags/android/" style="font-size: 20px;">Android</a> <a href="/tags/flutter/" style="font-size: 10px;">Flutter</a> <a href="/tags/python/" style="font-size: 10px;">Python</a>
        </div>
    </div>
    <a href="javascript:;" class="sidebar-menu-box-close">&times;</a>
</div>
<div class="mobile-header-menu-nav" id="mobile-header-menu-nav">
    <div class="mobile-header-menu-container">
        <span class="title">Menus</span>
        <ul class="mobile-header-menu-navbar">
            
            <li>
                <a href="/">
                    <i class="fa fa-home"></i><span>主页</span>
                </a>
            </li>
            
            <li>
                <a href="/archives">
                    <i class="fa fa-list"></i><span>全部</span>
                </a>
            </li>
            
            <li>
                <a href="/categories/essay">
                    <i class="fa fa-edit"></i><span>随笔</span>
                </a>
            </li>
            
            <li>
                <a href="/categories/note">
                    <i class="fa fa-sticky-note"></i><span>小知识</span>
                </a>
            </li>
            
            <li>
                <a href="/about">
                    <i class="fa fa-user"></i><span>关于</span>
                </a>
            </li>
            
        </ul>
    </div>
    <div class="mobile-header-tag-container">
        <span class="title">Tags</span>
        <div id="mobile-header-container-tags">
            <a href="/tags/android/" style="font-size: 20px;">Android</a> <a href="/tags/flutter/" style="font-size: 10px;">Flutter</a> <a href="/tags/python/" style="font-size: 10px;">Python</a>
        </div>
    </div>
</div>
<div class="search-wrap">
    <span class="search-close">&times;</span>
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
            <i class="icon icon-lg icon-chevron-left"></i>
        </a>
        <input class="search-field" placeholder="Search..." id="keywords">
        <a id="search-submit" href="javascript:;">
            <i class="fa fa-search"></i>
        </a>
    <div class="search-container" id="search-container">
        <ul class="search-result" id="search-result">
        </ul>
    </div>
</div>

<div id="search-tpl">
    <li class="search-result-item">
        <a href="{url}" class="search-item-li">
            <span class="search-item-li-title" title="{title}">{title}</span>
        </a>
    </li>
</div>
<script src="/js/search.js"></script>
<script src="/js/main.js"></script>


  <script src="//cdn.bootcss.com/particles.js/2.0.0/particles.min.js"></script>
  <div id="particles"></div>
  <script src="/js/particles.js"></script>







  <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  <script src="//cdn.bootcss.com/scrollReveal.js/3.0.5/scrollreveal.js"></script>
  <script src="/js/animate.js"></script>


  <script src="/js/pop-img.js"></script>
  <script>
     $(".article-entry p img").popImg();
  </script>

  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/miku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false}});</script></body>
</html>
