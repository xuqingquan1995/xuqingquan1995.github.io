<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <meta name="sogou_site_verification" content="6EV6mkKQug">
  
  <title>IT Go</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="瞎搞事的博客">
  
  <meta name="description" content="在一个木函早先版本，有一个挺炫酷的功能：网页转App。那么这么一个功能是怎么实现的呢？  方案预想如果我们使用IDE开发的话，这个功能完全可以使用一个WebView去实现，至于网页对应的URL只需要在打包的时候进行配置就行了，可是并无法做到在已安装App中直接出包并签名安装，而且在手机中，并没法直接将代码编译称APK。所以猜测一个木函是将一个已有的APK进行修改，然后进行签名。 本地修改APK如">
<meta name="keywords" content="Android">
<meta property="og:type" content="article">
<meta property="og:title" content="Android 本地打包签名方案尝试">
<meta property="og:url" content="https://blog.it9.top/essay/Android 本地打包签名方案尝试/index.html">
<meta property="og:site_name" content="IT Go">
<meta property="og:description" content="在一个木函早先版本，有一个挺炫酷的功能：网页转App。那么这么一个功能是怎么实现的呢？  方案预想如果我们使用IDE开发的话，这个功能完全可以使用一个WebView去实现，至于网页对应的URL只需要在打包的时候进行配置就行了，可是并无法做到在已安装App中直接出包并签名安装，而且在手机中，并没法直接将代码编译称APK。所以猜测一个木函是将一个已有的APK进行修改，然后进行签名。 本地修改APK如">
<meta property="og:locale" content="default">
<meta property="og:updated_time" content="2020-03-08T07:36:22.291Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Android 本地打包签名方案尝试">
<meta name="twitter:description" content="在一个木函早先版本，有一个挺炫酷的功能：网页转App。那么这么一个功能是怎么实现的呢？  方案预想如果我们使用IDE开发的话，这个功能完全可以使用一个WebView去实现，至于网页对应的URL只需要在打包的时候进行配置就行了，可是并无法做到在已安装App中直接出包并签名安装，而且在手机中，并没法直接将代码编译称APK。所以猜测一个木函是将一个已有的APK进行修改，然后进行签名。 本地修改APK如">
  
  
    <link rel="icon" href="/favicon.ico">
  
  <link href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  <script src="/js/pace.min.js"></script>
<script>
 (function() {
    var src;
    if (document.location.protocol == "http:") {
        src = "http://js.passport.qihucdn.com/11.0.1.js?55d431fa6c5ac2f680df02398a4e06a6";
    } else {
        src = "https://jspassport.ssl.qhimg.com/11.0.1.js?55d431fa6c5ac2f680df02398a4e06a6";
    }
    document.write('<script src="' + src + '" id="sozz"><\/script>');
    console.log("360push");
})(); (function() {
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    } else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
    console.log("baidupush");
})();
</script>
  

  
	<script>
	var _hmt = _hmt || [];
	(function() {
	  var hm = document.createElement("script");
	  hm.src = "//hm.baidu.com/hm.js?73ea46c1b5fcdd8bdba5763824704213";
	  var s = document.getElementsByTagName("script")[0]; 
	  s.parentNode.insertBefore(hm, s);
	})();
	</script>

  

</head>
</html>
<body>
  <div id="container">
      <header id="header">
    <div id="banner"></div>
    <div id="header-outer">
        <div id="header-menu" class="header-menu-pos animated">
            <div class="header-menu-container">
                <a href="/" class="left">
                    <span class="site-title">IT Go</span>
                </a>
                <nav id="header-menu-nav" class="right">
                    
                    <a href="/">
                        <i class="fa fa-home"></i>
                        <span>主页</span>
                    </a>
                    
                    <a href="/archives">
                        <i class="fa fa-list"></i>
                        <span>全部</span>
                    </a>
                    
                    <a href="/categories/essay">
                        <i class="fa fa-edit"></i>
                        <span>随笔</span>
                    </a>
                    
                    <a href="/categories/note">
                        <i class="fa fa-sticky-note"></i>
                        <span>小知识</span>
                    </a>
                    
                    <a href="/about">
                        <i class="fa fa-user"></i>
                        <span>关于</span>
                    </a>
                    
                </nav>
                <a class="mobile-header-menu-button">
                    <i class="fa fa-bars"></i>
                </a>
            </div>
        </div>
        <div id="header-row">
            <div id="logo">
                <a href="/">
                    <img src="/images/logo.jpeg" alt="logo">
                </a>
            </div>
            <div class="header-info">
                <div id="header-title">
                    
                    <h2>
                        瞎搞事
                    </h2>
                    
                </div>
                <div id="header-description">
                    
                    <h3>
                        瞎搞事，瞎折腾，瞎扯淡
                    </h3>
                    
                </div>
            </div>
            <nav class="header-nav">
                <div class="social">
                    
                        <a title="博客" target="_blank" href="/">
                            <i class="fa fa-home fa-2x"></i></a>
                    
                        <a title="GitHub" target="_blank" href="//github.com/xuqingquan1995">
                            <i class="fa fa-github fa-2x"></i></a>
                    
                        <a title="QQ" target="_blank" href="tencent://message/?uin=1324569122&Menu=yes&Service=300&sigT=42a1e5347953b64c5ff3980f8a6e644d4b31456cb0b6ac6b27663a3c4dd0f4aa14a543b1716f9d45">
                            <i class="fa fa-qq fa-2x"></i></a>
                    
                        <a title="Mail" target="_blank" href="mailto:xuqingquan1995@gmail.com">
                            <i class="fa fa-envelope fa-2x"></i></a>
                    
                </div>
            </nav>
        </div>
    </div>
</header>
      <div class="outer">
        <section id="main" class="body-wrap"><article id="post-Android 本地打包签名方案尝试" class="article article-type-post" itemscope="" itemprop="blogPost">
    <div class="article-inner">
        
        <header class="article-header">
            
  
    <h1 class="post-title" itemprop="name">
      Android 本地打包签名方案尝试
    </h1>
    <div class="post-title-bar">
      <ul>
          
              <li>
                  <i class="fa fa-book"></i>
                  
                      <a href="/categories/随笔/">随笔</a>
                  
              </li>
          
        <li>
          <i class="fa fa-calendar"></i>  2020-03-08
        </li>
        <li>
          <i class="fa fa-eye"></i>
          <span id="busuanzi_value_page_pv"></span>
        </li>
      </ul>
    </div>
  

            
        </header>
        
        <div class="article-entry post-content" itemprop="articleBody">
            
                
                <blockquote>
<p>在一个木函早先版本，有一个挺炫酷的功能：网页转App。那么这么一个功能是怎么实现的呢？</p>
</blockquote>
<h3 id="方案预想"><a href="#方案预想" class="headerlink" title="方案预想"></a>方案预想</h3><p>如果我们使用IDE开发的话，这个功能完全可以使用一个WebView去实现，至于网页对应的URL只需要在打包的时候进行配置就行了，可是并无法做到在已安装App中直接出包并签名安装，而且在手机中，并没法直接将代码编译称APK。所以猜测一个木函是将一个已有的APK进行修改，然后进行签名。</p>
<h3 id="本地修改APK"><a href="#本地修改APK" class="headerlink" title="本地修改APK"></a>本地修改APK</h3><p>如上分析，如果我们要对一个APK进行修改，dex代码部分在手机中修改自然是有难度了，但是如果对清单文件，或者是其他资源文件进行修改就比较有可能了。在Github上有找到一个Java项目<a href="https://github.com/8enet/apkeditor" target="_blank" rel="noopener">apkeditor</a>，运行了这个项目发现，这个项目可以做到修改清单文件内容，替换图片资源文件。</p>
<h3 id="本地签名"><a href="#本地签名" class="headerlink" title="本地签名"></a>本地签名</h3><h4 id="签名方案落后"><a href="#签名方案落后" class="headerlink" title="签名方案落后"></a>签名方案落后</h4><p>不过同样这个项目有其不足的地方，毕竟是5年前的项目了。在KeyHelper中有以下代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 签名前缀</span><br><span class="line"> * 首先用上面生成的keystore签名任意一个apk，解压出这个apk里面 META-INF/CERT.RSA 的文件</span><br><span class="line"> * @throws IOException</span><br><span class="line"> */</span><br><span class="line">private static void getSigPrefix() throws IOException, URISyntaxException &#123;</span><br><span class="line">    System.out.println(&quot;----------&quot;);</span><br><span class="line">    String rsaFileName=&quot;CERT.RSA&quot;;</span><br><span class="line">    File file = new File(ClassLoader.getSystemClassLoader().getResource(rsaFileName).toURI());</span><br><span class="line">    FileInputStream fis = new FileInputStream(file);</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * RSA-keysize signature-length</span><br><span class="line">     # 512         64</span><br><span class="line">     # 1024        128</span><br><span class="line">     # 2048        256</span><br><span class="line">     */</span><br><span class="line"></span><br><span class="line">    int same = (int) (file.length() - 64);  //当前-keysize 512</span><br><span class="line"></span><br><span class="line">    byte[] buff = new byte[same];</span><br><span class="line">    fis.read(buff, 0, same);</span><br><span class="line">    fis.close();</span><br><span class="line"></span><br><span class="line">    String string = new String(Base64.encodeBase64(buff), &quot;UTF-8&quot;);</span><br><span class="line">    System.out.println(&quot;sigPrefix  --&gt;&gt;  &quot; + string);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>很明显，这个签名长度只是512，在SignApk中有这样一段注释<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * HISTORICAL NOTE:</span><br><span class="line"> * &lt;p/&gt;</span><br><span class="line"> * Prior to the keylimepie release, SignApk ignored the signature</span><br><span class="line"> * algorithm specified in the certificate and always used SHA1withRSA.</span><br><span class="line"> * &lt;p/&gt;</span><br><span class="line"> * Starting with keylimepie, we support SHA256withRSA, and use the</span><br><span class="line"> * signature algorithm in the certificate to select which to use</span><br><span class="line"> * (SHA256withRSA or SHA1withRSA).</span><br><span class="line"> * &lt;p/&gt;</span><br><span class="line"> * Because there are old keys still in use whose certificate actually</span><br><span class="line"> * says &quot;MD5withRSA&quot;, we treat these as though they say &quot;SHA1withRSA&quot;</span><br><span class="line"> * for compatibility with older releases.  This can be changed by</span><br><span class="line"> * altering the getAlgorithm() function below.</span><br><span class="line"> */</span><br><span class="line">/**</span><br><span class="line"> *  原始代码见aosp项目目录 build/tools/signapk/SignApk.java</span><br><span class="line"> *  如何生成privateKey 和 sigPrefix 见&#123;@see KeyHelper&#125;</span><br><span class="line"> */</span><br></pre></td></tr></table></figure></p>
<p>以及这样一段代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">     * Add the hash(es) of every file to the manifest, creating it if</span><br><span class="line">     * necessary.</span><br><span class="line">     */</span><br><span class="line">    private Manifest addDigestsToManifest(JarFile jar)</span><br><span class="line">            throws IOException, GeneralSecurityException &#123;</span><br><span class="line">        Manifest input = jar.getManifest();</span><br><span class="line">        Manifest output = new Manifest();</span><br><span class="line">        Attributes main = output.getMainAttributes();</span><br><span class="line">        if (input != null) &#123;</span><br><span class="line">            main.putAll(input.getMainAttributes());</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            main.putValue(&quot;Manifest-Version&quot;, &quot;1.0&quot;);</span><br><span class="line">            main.putValue(&quot;Created-By&quot;, &quot;1.0 (Android SignApk)&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        MessageDigest md_sha1 = MessageDigest.getInstance(&quot;SHA1&quot;);</span><br><span class="line"></span><br><span class="line">        byte[] buffer = new byte[4096];</span><br><span class="line">        int num;</span><br><span class="line"></span><br><span class="line">        // We sort the input entries by name, and add them to the</span><br><span class="line">        // output manifest in sorted order.  We expect that the output</span><br><span class="line">        // map will be deterministic.</span><br><span class="line"></span><br><span class="line">        TreeMap&lt;String, JarEntry&gt; byName = new TreeMap&lt;String, JarEntry&gt;();</span><br><span class="line"></span><br><span class="line">        for (Enumeration&lt;JarEntry&gt; e = jar.entries(); e.hasMoreElements(); ) &#123;</span><br><span class="line">            JarEntry entry = e.nextElement();</span><br><span class="line">            byName.put(entry.getName(), entry);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        for (JarEntry entry : byName.values()) &#123;</span><br><span class="line">            String name = entry.getName();</span><br><span class="line">            if (!entry.isDirectory() &amp;&amp;</span><br><span class="line">                    (stripPattern == null || !stripPattern.matcher(name).matches())) &#123;</span><br><span class="line">                InputStream data = jar.getInputStream(entry);</span><br><span class="line">                while ((num = data.read(buffer)) &gt; 0) &#123;</span><br><span class="line">                    md_sha1.update(buffer, 0, num);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Attributes attr = null;</span><br><span class="line">                if (input != null) attr = input.getAttributes(name);</span><br><span class="line">                attr = attr != null ? new Attributes(attr) : new Attributes();</span><br><span class="line">                attr.putValue(&quot;SHA1-Digest&quot;, new String(Base64.encodeBase64(md_sha1.digest()), &quot;ASCII&quot;));</span><br><span class="line">                output.getEntries().put(name, attr);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return output;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p>
<p>并且分析了查看了签名文件的信息后<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Creation date: Sep 22, 2015</span><br><span class="line">Entry type: PrivateKeyEntry</span><br><span class="line">Certificate chain length: 1</span><br><span class="line">Certificate[1]:</span><br><span class="line">Owner: CN=z, OU=z, O=z, L=shanghai, ST=shanghai, C=cn</span><br><span class="line">Issuer: CN=z, OU=z, O=z, L=shanghai, ST=shanghai, C=cn</span><br><span class="line">Serial number: 139a3b79</span><br><span class="line">Valid from: Tue Sep 22 20:20:51 CST 2015 until: Thu Mar 29 20:20:51 CST 2125</span><br><span class="line">Certificate fingerprints:</span><br><span class="line">	 SHA1: BD:1C:65:A3:39:E6:D1:33:C3:C5:AD:B0:A4:22:05:BE:90:F3:6C:CD</span><br><span class="line">	 SHA256: 92:57:56:C8:CD:EF:4F:43:E9:FD:ED:2D:13:DE:47:0C:99:94:92:94:97:30:F1:B4:52:24:C5:19:A9:AC:BC:F9</span><br><span class="line">Signature algorithm name: SHA256withRSA</span><br><span class="line">Subject Public Key Algorithm: 512-bit RSA key (weak)</span><br><span class="line">Version: 3</span><br><span class="line"></span><br><span class="line">Extensions: </span><br><span class="line"></span><br><span class="line">#1: ObjectId: 2.5.29.14 Criticality=false</span><br><span class="line">SubjectKeyIdentifier [</span><br><span class="line">KeyIdentifier [</span><br><span class="line">0000: 9E 3B 67 C8 52 6E BA 7C   8F 6F E1 33 F0 5D F0 B8  .;g.Rn...o.3.]..</span><br><span class="line">0010: 95 31 A8 28                                        .1.(</span><br><span class="line">]</span><br><span class="line">]</span><br></pre></td></tr></table></figure></p>
<p>发现使用的是SHA256withRSA，512位RAS 进行签名的，而且从签名的APK来看，只是进行了V1签名，但现在V3签名都已经出来了</p>
<p>那么我们现在在进行签名的签名文件是怎样的呢？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Creation date: Oct 30, 2019</span><br><span class="line">Entry type: PrivateKeyEntry</span><br><span class="line">Certificate chain length: 1</span><br><span class="line">Certificate[1]:</span><br><span class="line">Owner: CN=y, OU=y, O=y, L=y, ST=y, C=y</span><br><span class="line">Issuer: CN=y, OU=y, O=y, L=y, ST=y, C=y</span><br><span class="line">Serial number: 693a88f7</span><br><span class="line">Valid from: Wed Oct 30 20:32:02 CST 2019 until: Sun Oct 23 20:32:02 CST 2044</span><br><span class="line">Certificate fingerprints:</span><br><span class="line">	 SHA1: 03:71:97:17:ED:B1:8B:84:BF:D3:61:AF:A1:AC:C0:22:4B:9D:E6:75</span><br><span class="line">	 SHA256: D5:E0:1D:B4:1E:9C:3F:8C:E4:3B:F0:B4:89:3D:44:F7:86:49:CE:C3:8B:BA:7A:14:C5:5F:3F:38:D5:6A:35:AC</span><br><span class="line">Signature algorithm name: SHA256withRSA</span><br><span class="line">Subject Public Key Algorithm: 2048-bit RSA key</span><br><span class="line">Version: 3</span><br></pre></td></tr></table></figure></p>
<p>以上是我们新建的签名文件，这个使用的是SHA256withRSA，2048位RAS 进行签名的。</p>
<h4 id="使用新的签名方案"><a href="#使用新的签名方案" class="headerlink" title="使用新的签名方案"></a>使用新的签名方案</h4><p>虽然以上的签名方案比较落后，但是他的这一段注释让我找到了方向<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> *  原始代码见aosp项目目录 build/tools/signapk/SignApk.java</span><br><span class="line"> *  如何生成privateKey 和 sigPrefix 见&#123;@see KeyHelper&#125;</span><br><span class="line"> */</span><br></pre></td></tr></table></figure></p>
<p>可以从Android源码去寻找最新的签名方案，从android sdk目录下的build-tools/28.0.3/lib/里面得到apksigner.jar，这个是build-tools 24以上才有的，只支持Android 7.0 以上系统运行，支持1-3代签名技术，但是同样的如果想要从电脑里面得到jarsigner就不太可能了，因为这个是由java提供的，是一个可执行文件，不是jar文件，但是在源码中存在这个文件 /prebuilts/sdk/tools/lib/signapk.jar，这个文件可以实现在Android 7.0以下运行，进行V1 签名。<br>通过以上操作，得到的两个jar文件，就可以实现在Android7.0以下进行1代签名和Android 7.0 以上进行1-3代签名了</p>
<h3 id="分离PK8和PEM"><a href="#分离PK8和PEM" class="headerlink" title="分离PK8和PEM"></a>分离PK8和PEM</h3><p>apksigner.jar 中有个文件help_sign.txt，里面有这样的一段使用帮助<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">        EXAMPLES</span><br><span class="line"></span><br><span class="line">1. Sign an APK, in-place, using the one and only key in keystore release.jks:</span><br><span class="line">$ apksigner sign --ks release.jks app.apk</span><br><span class="line"></span><br><span class="line">1. Sign an APK, without overwriting, using the one and only key in keystore</span><br><span class="line">   release.jks:</span><br><span class="line">$ apksigner sign --ks release.jks --in app.apk --out app-signed.apk</span><br><span class="line"></span><br><span class="line">3. Sign an APK using a private key and certificate stored as individual files:</span><br><span class="line">$ apksigner sign --key release.pk8 --cert release.x509.pem app.apk</span><br><span class="line"></span><br><span class="line">4. Sign an APK using two keys:</span><br><span class="line">$ apksigner sign --ks release.jks --next-signer --ks magic.jks app.apk</span><br><span class="line"></span><br><span class="line">5. Sign an APK using PKCS #11 JCA Provider:</span><br><span class="line">$ apksigner sign --provider-class sun.security.pkcs11.SunPKCS11 \</span><br><span class="line">    --provider-arg token.cfg --ks NONE --ks-type PKCS11 app.apk</span><br><span class="line"></span><br><span class="line">6. Sign an APK using a non-ASCII password KeyStore created on English Windows.</span><br><span class="line">   The --pass-encoding parameter is not needed if apksigner is being run on</span><br><span class="line">   English Windows with Java 8 or older.</span><br><span class="line">$ apksigner sign --ks release.jks --pass-encoding ibm437 app.apk</span><br><span class="line"></span><br><span class="line">7. Sign an APK on Windows using a non-ASCII password KeyStore created on a</span><br><span class="line">   modern OSX or Linux machine:</span><br><span class="line">$ apksigner sign --ks release.jks --pass-encoding utf-8 app.apk</span><br><span class="line"></span><br><span class="line">8. Sign an APK with rotated signing certificate:</span><br><span class="line">$ apksigner sign --ks release.jks --next-signer --ks release2.jks \</span><br><span class="line">    --lineage /path/to/signing/history/lineage app.apk</span><br></pre></td></tr></table></figure></p>
<p>说明了使用签名的几种方案，但是为了不用输入密码，我选取了第三种方案进行签名，这样的话就需要得到PK8文件和PEM文件了<br>网上找了ks2x509.jar这样的一个工具，可以从一个jks签名文件提取生成PK8文件和PEM文件</p>
<h3 id="signapk-准备"><a href="#signapk-准备" class="headerlink" title="signapk 准备"></a>signapk 准备</h3><p>由于signapk.jar 的入口文件SignApk并不是public，所以我们需要使用一个同包名的类才能调用到它<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">package com.android.signapk;</span><br><span class="line"></span><br><span class="line">public class ApkSignerProxy &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SignApk.main(args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="写一段测试代码"><a href="#写一段测试代码" class="headerlink" title="写一段测试代码"></a>写一段测试代码</h3><p>一切准备就行后，使用代码测试一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">findViewById(R.id.signButton).setOnClickListener(view -&gt; &#123;</span><br><span class="line">            File unsignFile = new File(</span><br><span class="line">                    Environment.getExternalStorageDirectory(),</span><br><span class="line">                    &quot;app_debug.apk&quot;</span><br><span class="line">            );</span><br><span class="line">            Log.d(TAG, &quot;unsignFile---&gt;&quot; + unsignFile.getAbsolutePath());</span><br><span class="line">            File outapk = new File(</span><br><span class="line">                    Environment.getExternalStorageDirectory(),</span><br><span class="line">                    &quot;temp.apk&quot;</span><br><span class="line">            );</span><br><span class="line">            Log.d(TAG, &quot;outapk---&gt;&quot; + outapk.getAbsolutePath());</span><br><span class="line">            if (outapk.exists()) &#123;</span><br><span class="line">                outapk.delete();</span><br><span class="line">            &#125;</span><br><span class="line">            File pk8 = new File(</span><br><span class="line">                    Environment.getExternalStorageDirectory(),</span><br><span class="line">                    &quot;testkey.pk8&quot;</span><br><span class="line">            );</span><br><span class="line">            Log.d(TAG, &quot;pk8---&gt;&quot; + pk8.getAbsolutePath());</span><br><span class="line">            File pem = new File(</span><br><span class="line">                    Environment.getExternalStorageDirectory(),</span><br><span class="line">                    &quot;testkey.x509.pem&quot;</span><br><span class="line">            );</span><br><span class="line">            Log.d(TAG, &quot;pem---&gt;&quot; + pem.getAbsolutePath());</span><br><span class="line">            try &#123;</span><br><span class="line">                Log.d(TAG, &quot;onClick: 签名开始&quot;);</span><br><span class="line">                if (Build.VERSION.SDK_INT &gt; Build.VERSION_CODES.M) &#123;</span><br><span class="line">                    ApkSignerTool.main(new String[]&#123;&quot;sign&quot;,</span><br><span class="line">                            &quot;--key&quot;,</span><br><span class="line">                            pk8.getAbsolutePath(),</span><br><span class="line">                            &quot;--cert&quot;,</span><br><span class="line">                            pem.getAbsolutePath(),</span><br><span class="line">                            &quot;--v2-signing-enabled&quot;,</span><br><span class="line">                            &quot;false&quot;,</span><br><span class="line">                            &quot;--out&quot;,</span><br><span class="line">                            outapk.getAbsolutePath(),</span><br><span class="line">                            &quot;--in&quot;,</span><br><span class="line">                            unsignFile.getAbsolutePath()&#125;);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    ApkSignerProxy.main(new String[]&#123;</span><br><span class="line">                            pem.getAbsolutePath(),</span><br><span class="line">                            pk8.getAbsolutePath(),</span><br><span class="line">                            unsignFile.getAbsolutePath(),</span><br><span class="line">                            outapk.getAbsolutePath()</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">                Log.d(TAG, &quot;onClick: 签名结束&quot;);</span><br><span class="line">            &#125; catch (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            while (!outapk.exists()) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(100);</span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            Log.d(TAG, &quot;签名完成&quot;);</span><br><span class="line">            runOnUiThread(() -&gt; Toast.makeText(MainActivity.this, &quot;签名完成&quot;, Toast.LENGTH_SHORT).show());</span><br><span class="line">            try &#123;</span><br><span class="line">                Thread.sleep(100);</span><br><span class="line">            &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure></p>
<p>运行后成功的在Android6.0设备和Android8.0设备对文件进行签名</p>
<h3 id="工具分享"><a href="#工具分享" class="headerlink" title="工具分享"></a>工具分享</h3><ul>
<li><a href="https://github.com/8enet/apkeditor" target="_blank" rel="noopener">apkeditor</a></li>
<li><a href="/blog_images/jar/apksigner.jar">apksigner.jar</a></li>
<li><a href="/blog_images/jar/signapk.jar">signapk.jar</a></li>
<li><a href="/blog_images/jar/ks2x509.jar">ks2x509.jar</a></li>
</ul>

                <div class="post-copyright">
    <div class="content">
        <p>最后更新： 2020年03月08日 15:36</p>
        <p>原始链接：
            
                <a class="post-url" href="/essay/Android 本地打包签名方案尝试/" title="Android 本地打包签名方案尝试">https://blog.it9.top/essay/Android 本地打包签名方案尝试/</a>
            
        </p>
        <footer>
            <a href="https://blog.it9.top">
                <img src="/images/logo.jpeg" alt="IT Go">
                IT Go
            </a>
        </footer>
    </div>
</div>

                
                
                
<div class="page-reward">
    <a id="rewardBtn" href="javascript:;">赏</a>
</div>

<div id="reward" class="post-modal reward-lay">
    <a class="close" href="javascript:;" id="reward-close">×</a>
    <span class="reward-title">
        <i class="icon icon-quote-left"></i>
        请我吃糖~
        <i class="icon icon-quote-right"></i>
    </span>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/images/wechat_code.png" alt="打赏二维码">
        </div>
        <div class="reward-select">
            
            <label class="reward-select-item checked" data-id="wechat" data-wechat="/images/wechat_code.png">
                <img class="reward-select-item-wechat" src="/images/wechat.png" alt="微信">
            </label>
            
            
            <label class="reward-select-item" data-id="alipay" data-alipay="/images/alipay_code.png">
                <img class="reward-select-item-alipay" src="/images/alipay.png" alt="支付宝">
            </label>
            
        </div>
    </div>
</div>


                
            </div>
            <footer class="article-footer">
                
                
<div class="post-share">
    <a href="javascript:;" id="share-sub" class="post-share-fab">
        <i class="fa fa-share-alt"></i>
    </a>
    <div class="post-share-list" id="share-list">
        <ul class="share-icons">
          <li>
            <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=https://blog.it9.top/essay/Android 本地打包签名方案尝试/&title=《Android 本地打包签名方案尝试》 — IT Go&pic=https://blog.it9.top/images/logo.jpeg" data-title="微博">
              <i class="fa fa-weibo"></i>
            </a>
          </li>
          <li>
            <a class="weixin share-sns" id="wxFab" href="javascript:;" data-title="微信">
              <i class="fa fa-weixin"></i>
            </a>
          </li>
          <li>
            <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=https://blog.it9.top/essay/Android 本地打包签名方案尝试/&title=《Android 本地打包签名方案尝试》 — IT Go&source=瞎搞事，瞎折腾，瞎扯淡" data-title="QQ">
              <i class="fa fa-qq"></i>
            </a>
          </li>
          <li>
            <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=https://blog.it9.top/essay/Android 本地打包签名方案尝试/" data-title="Facebook">
              <i class="fa fa-facebook"></i>
            </a>
          </li>
          <li>
            <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=《Android 本地打包签名方案尝试》 — IT Go&url=https://blog.it9.top/essay/Android 本地打包签名方案尝试/&via=https://blog.it9.top" data-title="Twitter">
              <i class="fa fa-twitter"></i>
            </a>
          </li>
          <li>
            <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=https://blog.it9.top/essay/Android 本地打包签名方案尝试/" data-title="Google+">
              <i class="fa fa-google-plus"></i>
            </a>
          </li>
        </ul>
     </div>
</div>
<div class="post-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;" id="wxShare-close">×</a>
    <p>扫一扫，分享到微信</p>
    <img src="//api.qrserver.com/v1/create-qr-code/?data=https://blog.it9.top/essay/Android 本地打包签名方案尝试/" alt="微信分享二维码">
</div>

<div class="mask"></div>

                
                <ul class="article-footer-menu">
                    
                    
  <li class="article-footer-tags">
    <i class="fa fa-tags"></i>
      
    <a href="/tags/android/" class="color3">Android</a>
      
  </li>

                </ul>
                
            </footer>
        </div>
</article>


    <aside class="post-toc-pos post-toc-top" id="post-toc">
        <nav class="post-toc-wrap">
            <ol class="post-toc"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#方案预想"><span class="post-toc-text">方案预想</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#本地修改APK"><span class="post-toc-text">本地修改APK</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#本地签名"><span class="post-toc-text">本地签名</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#签名方案落后"><span class="post-toc-text">签名方案落后</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#使用新的签名方案"><span class="post-toc-text">使用新的签名方案</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#分离PK8和PEM"><span class="post-toc-text">分离PK8和PEM</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#signapk-准备"><span class="post-toc-text">signapk 准备</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#写一段测试代码"><span class="post-toc-text">写一段测试代码</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#工具分享"><span class="post-toc-text">工具分享</span></a></li></ol>
        </nav>
    </aside>
    

<nav id="article-nav">
  
  
    <a href="/note/M3U8合并最简单的方法/" id="article-nav-older" class="article-nav-link-wrap">
      <span class="article-nav-title">M3U8合并最简单的方法</span>
      <i class="fa fa-hand-o-right" aria-hidden="true"></i>
    </a>
  
</nav>




<div id="SOHUCS" sid="Android 本地打包签名方案尝试"></div>
<script type="text/javascript">
    (function(){
        var appid = 'cytXViG69';
        var conf = 'prod_ec256658191d4702179ffc2efd670f6d';
        var width = window.innerWidth || document.documentElement.clientWidth;
        if (width < 960) {
            window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="https://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("https://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>

</section>
        
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info" class="inner">
      
<p>
    <span id="busuanzi_container_site_uv" style="display:none">
        总访客数：<span id="busuanzi_value_site_uv"></span>
    </span>
    <span id="busuanzi_container_site_pv" style="display:none">
        总访问量：<span id="busuanzi_value_site_pv"></span>
    </span>
</p>


      <p>
        Copyright &copy; 2020, All Rights Reserved.
      <br>Powered by  <a href="http://hexo.io/" target="_blank">Hexo</a>
        Theme <a href="https://github.com/wongminho/hexo-theme-miho" target="_blank">MiHo</a>
         change by <a href="mailto:xuqingquan1995@gmail.com" target="_blank"> IT Go</a>
         <br>闽ICP备17032899号-1
      </p>
    </div>
  </div>
</footer>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
<script>
  var mihoConfig = {
      root: "https://blog.it9.top",
      animate: true,
      isHome: false,
      share: true,
      reward: 1
  }
</script>
<div class="sidebar">
    <div id="sidebar-search" title="Search">
        <i class="fa fa-search"></i>
    </div>
    <div id="sidebar-category" title="Categories">
        <i class="fa fa-book"></i>
    </div>
    <div id="sidebar-tag" title="Tags">
        <i class="fa fa-tags"></i>
    </div>
    <div id="sidebar-top">
        <span class="sidebar-top-icon"><i class="fa fa-angle-up"></i></span>
    </div>
</div>
<div class="sidebar-menu-box" id="sidebar-menu-box">
    <div class="sidebar-menu-box-container">
        <div id="sidebar-menu-box-categories">
            <a class="category-link" href="/categories/note/">小知识</a><a class="category-link" href="/categories/essay/">随笔</a>
        </div>
        <div id="sidebar-menu-box-tags">
            <a href="/tags/android/" style="font-size: 20px;">Android</a> <a href="/tags/flutter/" style="font-size: 10px;">Flutter</a> <a href="/tags/python/" style="font-size: 10px;">Python</a>
        </div>
    </div>
    <a href="javascript:;" class="sidebar-menu-box-close">&times;</a>
</div>
<div class="mobile-header-menu-nav" id="mobile-header-menu-nav">
    <div class="mobile-header-menu-container">
        <span class="title">Menus</span>
        <ul class="mobile-header-menu-navbar">
            
            <li>
                <a href="/">
                    <i class="fa fa-home"></i><span>主页</span>
                </a>
            </li>
            
            <li>
                <a href="/archives">
                    <i class="fa fa-list"></i><span>全部</span>
                </a>
            </li>
            
            <li>
                <a href="/categories/essay">
                    <i class="fa fa-edit"></i><span>随笔</span>
                </a>
            </li>
            
            <li>
                <a href="/categories/note">
                    <i class="fa fa-sticky-note"></i><span>小知识</span>
                </a>
            </li>
            
            <li>
                <a href="/about">
                    <i class="fa fa-user"></i><span>关于</span>
                </a>
            </li>
            
        </ul>
    </div>
    <div class="mobile-header-tag-container">
        <span class="title">Tags</span>
        <div id="mobile-header-container-tags">
            <a href="/tags/android/" style="font-size: 20px;">Android</a> <a href="/tags/flutter/" style="font-size: 10px;">Flutter</a> <a href="/tags/python/" style="font-size: 10px;">Python</a>
        </div>
    </div>
</div>
<div class="search-wrap">
    <span class="search-close">&times;</span>
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
            <i class="icon icon-lg icon-chevron-left"></i>
        </a>
        <input class="search-field" placeholder="Search..." id="keywords">
        <a id="search-submit" href="javascript:;">
            <i class="fa fa-search"></i>
        </a>
    <div class="search-container" id="search-container">
        <ul class="search-result" id="search-result">
        </ul>
    </div>
</div>

<div id="search-tpl">
    <li class="search-result-item">
        <a href="{url}" class="search-item-li">
            <span class="search-item-li-title" title="{title}">{title}</span>
        </a>
    </li>
</div>
<script src="/js/search.js"></script>
<script src="/js/main.js"></script>


  <script src="//cdn.bootcss.com/particles.js/2.0.0/particles.min.js"></script>
  <div id="particles"></div>
  <script src="/js/particles.js"></script>







  <link rel="stylesheet" href="//cdn.bootcss.com/animate.css/3.5.0/animate.min.css">
  <script src="//cdn.bootcss.com/scrollReveal.js/3.0.5/scrollreveal.js"></script>
  <script src="/js/animate.js"></script>


  <script src="/js/pop-img.js"></script>
  <script>
     $(".article-entry p img").popImg();
  </script>

  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/miku.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false}});</script></body>
</html>
